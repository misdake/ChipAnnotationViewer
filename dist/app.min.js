(function(e){"function"==typeof define&&define.amd?define(e):e()})(function(){'use strict';var n=Math.round,o=Math.sqrt,i=Math.max,a=Math.min;function e(e,t){function n(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function t(e,t){return"rgba("+e.r+","+e.g+","+e.b+","+t.value+")"}var l=/** @class */function(){return function(e,t,n,o){this.left=e,this.top=t,this.width=n,this.height=o}}(),r=/** @class */function(){function e(e,t,n){this.canvas=e,this.canvasElement=t,this.context=n}return e.prototype.clear=function(){this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvasElement.width,this.canvasElement.height)},e.prototype.setColor=function(e){this.context.fillStyle=e,this.context.strokeStyle=e},e.prototype.setFillColor=function(e){this.context.fillStyle=e},e.prototype.setStrokeColor=function(e){this.context.strokeStyle=e},e.prototype.calculateLineWidth=function(e,t){if(!t)return 1;var n=t.onScreen,o=e.canvasSizeToScreen(t.onCanvas),i=t.ofScreen*a(this.canvasElement.width,this.canvasElement.height);return n+o+i},e.prototype.renderPolyline=function(e,t,n,o,a,l){if(0!=t.length){this.context.lineWidth=this.calculateLineWidth(e,l),this.context.beginPath(),this.context.lineCap="round",this.context.lineJoin="round";var r=e.canvasToScreen(t[0].x,t[0].y);this.context.moveTo(r.x,r.y);for(var s,p=1;p<t.length;p++)s=e.canvasToScreen(t[p].x,t[p].y),this.context.lineTo(s.x,s.y);n&&this.context.closePath(),o&&this.context.fill(),a&&this.context.stroke()}},e.prototype.testImageVisibility=function(e,t,n,o,i,a){//transform to screen space
var r=e.canvasToScreen(n.position.x,n.position.y),s=e.canvasSizeToScreen(o),p=e.canvasSizeToScreen(i);//skip out-of-screen images
return r.x-a>this.canvas.getWidth()||r.y-a>this.canvas.getHeight()?null:0>r.x+s+a||0>r.y+p+a?null:new l(r.x,r.y,s,p)},e.prototype.renderImage=function(e,t,n,o,i){var a=this.testImageVisibility(e,t,n,o,i,0);this.drawImage(t,a)},e.prototype.drawImage=function(e,t){t&&this.context.drawImage(e,t.left,t.top,t.width,t.height)},e.prototype.renderCircle=function(e,t,n,o,i,a,l){var r=e.canvasToScreen(t,n),s=e.canvasSizeToScreen(o);this.drawCircle(r.x,r.y,s,i,a),this.context.lineWidth=this.calculateLineWidth(e,l)},e.prototype.drawCircle=function(e,t,n,o,i,a){var l=Math.PI;a&&(this.context.lineWidth=a),this.context.beginPath(),this.context.arc(e,t,n,0,2*l),this.context.closePath(),o&&this.context.fill(),i&&this.context.stroke()},e.prototype.drawRect=function(e,t,n,o,i,a,l){l&&(this.context.lineWidth=l),this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(e,o),this.context.lineTo(n,o),this.context.lineTo(n,t),this.context.closePath(),i&&this.context.fill(),a&&this.context.stroke()},e.prototype.measureText=function(e,t,n){var o=this.calculateLineWidth(e,n);this.context.font=o+"px Arial";var i=this.context.measureText(t);return[i.width,o]},e.prototype.renderText=function(e,t,n,o,i,a,l){var r=e.canvasToScreen(o,i);this.drawText(t,n,r.x,r.y,a,l)},e.prototype.drawText=function(e,t,n,o,i,a){this.context.textAlign=i,this.context.textBaseline=a,this.context.font=t+"px Arial",this.context.fillText(e,n,o)},e}(),s=/** @class */function(){return function(){this.position=new p(0,0)}}(),p=/** @class */function(){return function(e,t){this.x=e,this.y=t}}(),d=/** @class */function(){function e(){this.position=new p(0,0)}return e.prototype.load=function(e,t){this.canvas=e,this.zoomMin=0,this.zoomMax=t.maxLevel,this.zoom=t.maxLevel,this.checkZoom(),this.position.x=t.width/2,this.position.y=t.height/2,this.xMin=0,this.xMax=t.width,this.yMin=0,this.yMax=t.height},e.prototype.moveXy=function(e,t){this.position.x+=e,this.position.y+=t,this.checkXy()},e.prototype.checkXy=function(){this.position.x=a(i(this.position.x,this.xMin),this.xMax),this.position.y=a(i(this.position.y,this.yMin),this.yMax)},e.prototype.getZoom=function(){return this.zoom},e.prototype.changeZoomBy=function(e){this.zoom+=e,this.checkZoom()},e.prototype.setZoomTo=function(e){this.zoom=e,this.checkZoom()},e.prototype.checkZoom=function(){this.zoom=a(i(this.zoom,this.zoomMin),this.zoomMax)},e.prototype.action=function(){if(this.canvas){this.checkXy(),this.checkZoom();var e=1/(1<<this.zoom);this.scale=e,this.tx=this.canvas.getWidth()/2-this.position.x*e,this.ty=this.canvas.getHeight()/2-this.position.y*e}},e.prototype.screenXyToCanvas=function(e,t){var n=(e-this.tx)/this.scale,o=(t-this.ty)/this.scale;return new p(n,o)},e.prototype.canvasToScreen=function(e,t){var n=e*this.scale+this.tx,o=t*this.scale+this.ty;return new p(n,o)},e.prototype.screenSizeToCanvas=function(e){return e/this.scale},e.prototype.canvasSizeToScreen=function(e){return e*this.scale},e.prototype.canvasAABBInScreen=function(e){var t=e.x1*this.scale+this.tx,n=e.y1*this.scale+this.ty,o=e.x2*this.scale+this.tx,i=e.y2*this.scale+this.ty,a=this.canvas.getWidth(),l=this.canvas.getHeight();return!(0>o||t>a||0>i||n>l)},e}(),y=/** @class */function(){return function(){}}(),c=function(e,t){return c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},c(e,t)},m=/** @class */function(){function e(e,t,n,o){this.name=e,this.r=t,this.g=n,this.b=o}return e.findByName=function(e){for(var t,n=0,o=this.list;n<o.length;n++)if(t=o[n],e==t.name)return t;return this.list[0]},e.list=[new e("red",255,0,0),new e("green",0,255,0),new e("blue",0,0,255),new e("cyan",0,255,255),new e("purple",255,0,255),new e("yellow",255,255,0),new e("gray",127,127,127),new e("white",255,255,255)],e}(),u=/** @class */function(){function e(e,t,n){this.name=e,this.buttonColor=t,this.value=n}return e.findByName=function(e){for(var t,n=0,o=this.list;n<o.length;n++)if(t=o[n],e==t.name)return t;return this.list[0]},e.findByValue=function(e){for(var t,n=0,o=this.list;n<o.length;n++)if(t=o[n],e==t.value)return t;return this.list[0]},e.list=[new e("15","rgb(217,217,217)",.15),new e("25","rgb(191,191,191)",.25),new e("50","rgb(127,127,127)",.5),new e("75","rgb(63,63,63)",.75),new e("100","rgb(0,0,0)",1)],e}(),g=/** @class */function(){function e(){}return e.prototype.onkeydown=function(){return!1},e.prototype.onkeyup=function(){return!1},e.prototype.onkeypress=function(){return!1},e}(),h=/** @class */function(){function t(){}return t.isMobile=function(){return /Mobi|Android/i.test(navigator.userAgent)},t.createPolylineKeyboardListener=function(n,o,i,a){return new(/** @class */function(l){function r(){return null!==l&&l.apply(this,arguments)||this}return e(r,l),r.prototype.onkeydown=function(e){var l=o.screenSizeToCanvas(1),r=t.getMove(e,l),s=r.dx,p=r.dy;return(0!==s||0!==p)&&i.editor.move(s,p),"Delete"===e.key&&a&&a(),n.requestRender(),!0},r}(g))},t.createTextKeyboardListener=function(n,o,i,a){return new(/** @class */function(l){function r(){return null!==l&&l.apply(this,arguments)||this}return e(r,l),r.prototype.onkeydown=function(e){var l=o.screenSizeToCanvas(1),r=t.getMove(e,l),s=r.dx,p=r.dy;return(0!==s||0!==p)&&i.setPosition(i.x+s,i.y+p),"Delete"===e.key&&a&&a(),n.requestRender(),!0},r}(g))},t.getMove=function(e,t){var n=0,o=0;switch(e.ctrlKey&&(t*=10),e.key){case"w":case"ArrowUp":o-=t;break;case"a":case"ArrowLeft":n-=t;break;case"s":case"ArrowDown":o+=t;break;case"d":case"ArrowRight":n+=t;}return{dx:n,dy:o}},t.copyToClipboard=function(e){var t=document.getElementById(e);t.select(),document.execCommand("Copy"),t.blur()},t.setContent=function(e,t){var n=document.getElementById(e);n.innerHTML=t},t.bindButtonOnClick=function(e,t){var n=document.getElementById(e);n.onclick=t},t.setVisibility=function(e,t,n){void 0===n&&(n="block");var o=document.getElementById(e);o.style.display=t?n:"none"},t.bindCheckbox=function(e,t,n){var o=document.getElementById(e);o.checked=t,o.onchange=function(){n(o.checked)}},t.bindSelect=function(e,t,n,o){var i=document.getElementById(e);i.options.length=0;for(var a,l=0,r=t;l<r.length;l++)a=r[l],i.add(new Option(a,a));var s=t.indexOf(n);0<s&&(i.options[s].selected=!0),i.onchange=function(){o(i.selectedIndex,i.options[i.selectedIndex].value)}},t.bindValue=function(e,t,n){var o=document.getElementById(e);o.value=t,o.oninput=o.onchange=function(){n(o.value)}},t.bindColor=function(e,t,n,o,i){var a=document.getElementById(e),l=document.getElementById(t);a.innerHTML="",l.innerHTML="";for(var r=n,s=o,p=0,d=m.list;p<d.length;p++){var y=d[p],c=e+"_"+y.name,g="background:"+y.name;a.innerHTML=a.innerHTML+"<button id=\""+c+"\" class=\"configColorButton\" style=\""+g+"\"></button>\n"}for(var h=0,x=u.list;h<x.length;h++){var f=x[h],c=t+"_"+f.name,g="background:"+f.buttonColor;l.innerHTML=l.innerHTML+"<button id=\""+c+"\" class=\"configAlphaButton\" style=\""+g+"\"></button>\n"}for(var y,v=function(t){var n=e+"_"+t.name,o=document.getElementById(n);o.onclick=function(){r=t,i(r,s)}},b=0,C=m.list;b<C.length;b++)y=C[b],v(y);for(var f,E=function(e){var n=t+"_"+e.name,o=document.getElementById(n);o.onclick=function(){s=e,i(r,s)}},_=0,T=u.list;_<T.length;_++)f=T[_],E(f)},t.bindNumber=function(e,t,n){var o=document.getElementById(e);o.value=t.toString(),o.oninput=o.onchange=function(){var e=parseFloat(o.value);0<=e?n(e):(o.value="0",n(0))}},t}(),x=/** @class */function(){function e(e,t){this.renderNext=!1,this.map=null,this.data=null,this.domElement=e,this.domElement.innerHTML+="<canvas id=\""+t+"\" tabindex='0' style='width:100%;height:100%;overflow:hidden;display:inline-block;'></canvas>",this.domElement.oncontextmenu=function(){return!1;//disable context menu
},this.canvasElement=document.getElementById(t),this.context=this.canvasElement.getContext("2d"),this.camera=new d,this.renderer=new r(this,this.canvasElement,this.context),this.width=this.canvasElement.clientWidth,this.height=this.canvasElement.clientHeight;var n=this;window.addEventListener("resize",function(){n.requestRender()})}return e.prototype.getCamera=function(){return this.camera},e.prototype.init=function(){var e=this;if(this.layers=[],this.canvasElement.onclick=function(t){e.canvasElement.focus(),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.onclick(t)));a--);},this.canvasElement.ondblclick=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.ondblclick(t)));a--);},this.canvasElement.onwheel=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.onwheel(t)));a--);},this.canvasElement.onmousedown=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.onmousedown(t)));a--);},this.canvasElement.onmouseup=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.onmouseup(t)));a--);},this.canvasElement.onmousemove=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.onmousemove(t)));a--);},this.canvasElement.onmouseout=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.onmouseout(t)));a--);},this.canvasElement.onkeydown=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.keyboardListener&&n.keyboardListener.onkeydown(t)));a--);},this.canvasElement.onkeyup=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.keyboardListener&&n.keyboardListener.onkeyup(t)));a--);},this.canvasElement.onkeypress=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.keyboardListener&&n.keyboardListener.onkeypress(t)));a--);},h.isMobile()){var t=new Hammer(this.canvasElement);t.get("pan").set({direction:Hammer.DIRECTION_ALL}),t.on("pan",function(t){t.preventDefault();for(var n,o=e.layers.length,a=o-1;0<=a&&(n=e.layers[a],!(n.mouseListener&&n.mouseListener.onpan(t)));a--);})}},e.prototype.addLayer=function(e){this.layers.push(e)},e.prototype.findLayer=function(e){for(var t,n=0,o=this.layers;n<o.length;n++)if(t=o[n],t.name==e)return t;return null},e.prototype.getWidth=function(){return this.width},e.prototype.getHeight=function(){return this.height},e.prototype.requestRender=function(){if(!this.renderNext){this.renderNext=!0;var e=this;requestAnimationFrame(function(){e.renderNext=!1,e.render()})}},e.prototype.loadMap=function(e){if(!this.map||this.map.name!=e.name){this.camera.load(this,e);for(var t,n=0,o=this.layers;n<o.length;n++)t=o[n],t.loadMap(e)}this.map=e},e.prototype.loadData=function(e){if(this.data!=e)for(var t,n=0,o=this.layers;n<o.length;n++)t=o[n],t.loadData(e);this.data=e},e.prototype.save=function(){for(var e,t=new y,n=0,o=this.layers;n<o.length;n++)e=o[n],e.saveData(t);return t},e.prototype.render=function(){this.width=this.canvasElement.clientWidth,this.height=this.canvasElement.clientHeight,this.canvasElement.width!==this.width&&(this.canvasElement.width=this.width),this.canvasElement.height!==this.height&&(this.canvasElement.height=this.height),this.camera.action(),this.renderer.clear();for(var e,t=0,n=this.layers;t<n.length;t++)e=n[t],e.render(this.renderer)},e}(),f=/** @class */function(){function e(){}return e.get=function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState&&200==n.status&&t(n.responseText)},n.open("GET",e,!0),n.send()},e}(),v=/** @class */function(){function e(e,t){this._mouseListener=null,this._keyboardListener=null,this.name=e,this.canvas=t,this.camera=t.getCamera()}return Object.defineProperty(e.prototype,"mouseListener",{get:function(){return this._mouseListener},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"keyboardListener",{get:function(){return this._keyboardListener},enumerable:!0,configurable:!0}),e.prototype.loadMap=function(){},e.prototype.loadData=function(){},e.prototype.saveData=function(){},e.prototype.render=function(){},e.prototype.unload=function(){},e}(),b=/** @class */function(){function e(){this.transformation=new s}return e.prototype.render=function(){},e}(),C=/** @class */function(t){function n(e,n,o,i,a,l){var r=t.call(this)||this;r.transformation.position.x=n,r.transformation.position.y=o,r.w=i,r.h=a,r.img=new Image,r.src=e,r.loaded=!1;return r.img.onload=function(){r.loaded=!0,l&&l(r)},r}return e(n,t),n.prototype.loadIfNotLoaded=function(){this.loading||(this.loading=!0,this.img.src=this.src)},n.prototype.render=function(e,t,n){var o=t.testImageVisibility(n,this.img,this.transformation,this.w,this.h,100);o&&(this.loadIfNotLoaded(),this.loaded&&t.drawImage(this.img,o))},n}(b),E=/** @class */function(){function e(){}return e.prototype.onclick=function(){return!1},e.prototype.ondblclick=function(){return!1},e.prototype.onwheel=function(){return!1},e.prototype.onmousedown=function(){return!1},e.prototype.onmouseup=function(){return!1},e.prototype.onmousemove=function(){return!1},e.prototype.onmouseout=function(){return!1},e.prototype.onpan=function(){return!1},e}(),_=/** @class */function(){function e(){}return e.register=function(e,t,n){e?(t&&(this.mapSelect[e]=this.mapSelect[e]||[],this.mapSelect[e].push(t)),n&&(this.mapDeselect[e]=this.mapDeselect[e]||[],this.mapDeselect[e].push(n))):this.listDeselect.push(n)},e.deselectAny=function(){this.selected&&this.deselect(this.selectedType)},e.deselect=function(e){if(this.selectedType==e){var t=this.mapDeselect[e];if(t)for(var n,o=0,i=t;o<i.length;o++)n=i[o],n();for(var n,a=0,l=this.listDeselect;a<l.length;a++)n=l[a],n();this.selectedType=null,this.selected=null}},e.select=function(e,t){this.deselectAny(),this.selected=t,this.selectedType=e;var n=this.mapSelect[e];if(n)for(var o,i=0,a=n;i<a.length;i++)o=a[i],o(t)},e.listDeselect=[],e.mapSelect={},e.mapDeselect={},e}(),T=/** @class */function(){function e(){}return e.IMAGE="image",e.POLYLINE_CREATE="polyline_create",e.POLYLINE_EDIT="polyline_edit",e.POLYLINE_VIEW="polyline_view",e.TEXT_CREATE="text_create",e.TEXT_EDIT="text_edit",e.TEXT_VIEW="text_view",e}(),k=/** @class */function(t){function n(e){var o=t.call(this,T.IMAGE,e)||this;return _.register(null,null,function(){h.setContent(n.HINT_ELEMENT_ID,n.HINT_VIEW)}),h.setContent(n.HINT_ELEMENT_ID,n.HINT_VIEW),o}return e(n,t),n.prototype.loadMap=function(t){var n=this;this.map=t,this.maxLevel=t.maxLevel;var o=t.githubRepo.indexOf("/"),i=t.githubRepo.substring(0,o),a=t.githubRepo.substring(o+1);this.baseFolder="https://"+i+".github.io/"+a+"/"+this.map.name,this.currentZoom=-1;var l=document.getElementById("imageSource");h.setVisibility("imageSource",!!t.source,"inline"),t.source&&(l.href=t.source,l.innerHTML=t.source),h.bindButtonOnClick("buttonZoomIn",function(){n.camera.changeZoomBy(-1),n.camera.action(),n.canvas.requestRender()}),h.bindButtonOnClick("buttonZoomOut",function(){n.camera.changeZoomBy(1),n.camera.action(),n.canvas.requestRender()});var r=this;this._mouseListener=new(/** @class */function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.down=!1,e.lastX=-1,e.lastY=-1,e.lastPanX=-1,e.lastPanY=-1,e}return e(n,t),n.prototype.onwheel=function(e){var t=r.canvas.getCamera();t.action();var n=t.screenXyToCanvas(e.offsetX,e.offsetY);t.changeZoomBy(0<e.deltaY?1:-1),t.action();var o=t.screenXyToCanvas(e.offsetX,e.offsetY),i=n.x-o.x,a=n.y-o.y;return t.moveXy(i,a),r.canvas.requestRender(),!0},n.prototype.onmousedown=function(e){return this.down=!0,this.lastX=e.offsetX,this.lastY=e.offsetY,!0},n.prototype.onmouseup=function(){return this.down=!1,!0},n.prototype.onmousemove=function(e){if(this.down&&0<e.buttons){var t=r.canvas.getCamera();t.action();var n=t.screenXyToCanvas(this.lastX,this.lastY),o=t.screenXyToCanvas(e.offsetX,e.offsetY),i=n.x-o.x,a=n.y-o.y;return t.moveXy(i,a),this.lastX=e.offsetX,this.lastY=e.offsetY,r.canvas.requestRender(),!0}return!1},n.prototype.onpan=function(e){var t=e.deltaX-this.lastPanX,n=e.deltaY-this.lastPanY,o=r.canvas.getCamera(),i=o.screenSizeToCanvas(1);return o.moveXy(-t*i,-n*i),r.canvas.requestRender(),console.log("onpan",e.isFirst,e.isFinal,e.deltaX,e.deltaY,t,n),this.lastPanX=e.deltaX,this.lastPanY=e.deltaY,e.isFinal&&(this.lastPanX=0,this.lastPanY=0),!0},n}(E))},n.prototype.prepare=function(e,t){var n=e.getZoom();if(this.currentZoom!==n){this.currentZoom=n;var o=this.map.tileSize<<n,a=this.map.levels[n];this.xCount=a.xMax,this.yCount=a.yMax,this.imageMatrix=[];for(var l=0;l<this.xCount;l++){this.imageMatrix[l]=[];for(var r=0;r<this.yCount;r++)this.imageMatrix[l][r]=new C(this.baseFolder+"/"+n+"/"+l+"_"+r+".jpg",l*o,r*o,o,o,function(){t.requestRender()})}}},n.prototype.render=function(e){this.prepare(this.camera,this.canvas);var t=this.camera.screenSizeToCanvas(1);if(h.setContent("textZoomInfo",(1<t?"1/":"")+t+"x"),this.imageMatrix)for(var n=0;n<this.xCount;n++)for(var o=0;o<this.yCount;o++)this.imageMatrix[n][o].render(this.canvas,e,this.camera)},n.prototype.unload=function(){t.prototype.unload.call(this)},n.HINT_ELEMENT_ID="hint",n.HINT_VIEW="1. hold mouse button to drag<br>2. left click polygon/text to select<br>3. mouse wheel to zoom<br>",n}(v),S=/** @class */function(){function e(e,t,n,o){void 0===e&&(e=a()),void 0===t&&(t=a()),void 0===n&&(n=i()),void 0===o&&(o=i()),this.x1=e,this.y1=t,this.x2=n,this.y2=o}return e.prototype.set=function(e,t,n,o){this.x1=e,this.y1=t,this.x2=n,this.y2=o},e}(),I=/** @class */function(){return function(e,t){this.x=e,this.y=t}}(),w=/** @class */function(){return function(e,t,n,o){this.position=e,this.p1Index=t,this.p2Index=n,this.distance=o}}(),P=/** @class */function(){return function(e,t,n,o,i,a,l,r,s){this.points=e,this.closed=t,this.lineWidth=n,this.fill=o,this.fillColorName=i,this.fillAlphaName=a,this.stroke=l,this.strokeColorName=r,this.strokeAlphaName=s}}(),L=/** @class */function(){function e(e,t){this.polyline=e,this.points=t}return e.sqr=function(e,t){return e*e+t*t},e.testPointSegment=function(t,n,i,a,l){var r=t[n],s=t[i],p=s.x-r.x,d=s.y-r.y,y=e.sqr(p,d);if(1e-4>y)return null;var c=((a-r.x)*p+(l-r.y)*d)/y;1<c&&(c=1),0>c&&(c=0);var m=r.x+c*p,u=r.y+c*d,g=e.sqr(a-m,l-u);return new w(new I(m,u),n,i,o(g))},e.testPointPolygon=function(e,t,n){for(var o=e.length,a=!1,l=0,s=o-1;l<o;s=l++)e[l].y>n!=e[s].y>n&&t<(e[s].x-e[l].x)*(n-e[l].y)/(e[s].y-e[l].y)+e[l].x&&(a=!a);return a},e.prototype.pickPoint=function(t,n,o){for(var i,a=this.points,l=0,r=a;l<r.length;l++)if(i=r[l],e.sqr(i.x-t,i.y-n)<=o*o)return a.indexOf(i);return null},e.prototype.pickLine=function(t,n,o){for(var a=Number.MAX_VALUE,l,r=null,s=a,p=this.points,d=p.length,y=0,c=d-1;y<d;c=y++)l=e.testPointSegment(p,y,c,t,n),l&&l.distance<o&&l.distance<s&&(s=l.distance,r=l);return r},e.prototype.pickShape=function(t,n){return this.polyline.style.fill&&e.testPointPolygon(this.points,t,n)},e}(),N=/** @class */function(){function e(e,t){this.polyline=e,this.points=t}return e.prototype.forEachPoint=function(e){this.points.forEach(function(t,n){e(t.x,t.y,n)})},e.prototype.pointCount=function(){return this.points.length},e.prototype.getPoint=function(e){var t=this.points;return e=(e+t.length)%t.length,t[e]},e.prototype.addPoint=function(e,t){this.points.push(new I(e,t)),this.polyline.invalidate()},e.prototype.insertPoint=function(e,t,n){void 0===n&&(n=-1);var o=this.points;n=(n+o.length)%o.length,o.splice(n,0,new I(e,t)),this.polyline.invalidate()},e.prototype.removePoint=function(e){var t=this.points;e=(e+t.length)%t.length,t.splice(e,1),this.polyline.invalidate()},e.prototype.setPoint=function(e,t,n){var o=this.points;e=(e+o.length)%o.length;var i=o[e];i.x=t,i.y=n,this.polyline.invalidate()},e.prototype.move=function(e,t){for(var n,o=0,i=this.points;o<i.length;o++)n=i[o],n.x+=e,n.y+=t;this.polyline.invalidate()},e.prototype.flipX=function(){for(var e,t=a(),n=i(),o=0,l=this.points;o<l.length;o++)e=l[o],t=a(t,e.x),n=i(n,e.x);for(var e,r=t+n,s=0,p=this.points;s<p.length;s++)e=p[s],e.x=r-e.x},e.prototype.flipY=function(){for(var e,t=a(),n=i(),o=0,l=this.points;o<l.length;o++)e=l[o],t=a(t,e.y),n=i(n,e.y);for(var e,r=t+n,s=0,p=this.points;s<p.length;s++)e=p[s],e.y=r-e.y},e.prototype.rotateCW=function(){for(var e=this.polyline.calculator.aabbCenter(),t=0,n=this.points;t<n.length;t++){var o=n[t],i=o.x-e.x,a=o.y-e.y;o.x=e.x-a,o.y=e.y+i}},e.prototype.rotateCCW=function(){for(var e=this.polyline.calculator.aabbCenter(),t=0,n=this.points;t<n.length;t++){var o=n[t],i=o.x-e.x,a=o.y-e.y;o.x=e.x+a,o.y=e.y-i}},e}(),A=/** @class */function(){var t=Math.abs;function e(e,t){this.polyline=e,this.points=t}return e.prototype.centroid=function(){for(var e=0,t=0,n=0,o=0;o<this.points.length;o++){var a=this.points[o],l=this.points[(o+1)%this.points.length],r=a.x*l.y-l.x*a.y;e+=r,t+=(a.x+l.x)*r,n+=(a.y+l.y)*r}var s=t/6/(e/2),p=n/6/(e/2);return new I(s,p)},e.prototype.aabb=function(e){void 0===e&&(e=new S),e||(e=new S);for(var t,n=a(),o=i(),l=a(),r=i(),s=0,p=this.points;s<p.length;s++)t=p[s],n=a(n,t.x),o=i(o,t.x),l=a(l,t.y),r=i(r,t.y);return e.set(n,l,o,r),e},e.prototype.aabbCenter=function(){var e=this.aabb(),t=new I((e.x1+e.x2)/2,(e.y1+e.y2)/2);return t},e.prototype.area=function(){if(3>this.points.length)return 0;for(var e=this.points[0].y*(this.points[this.points.length-1].x-this.points[1].x),n=1;n<this.points.length;n++)e+=this.points[n].y*(this.points[n-1].x-this.points[(n+1)%this.points.length].x);return t(.5*e)},e.prototype.length=function(){if(2>this.points.length)return 0;var t=0,n=this.points[0],o=this.points[this.points.length-1];this.polyline.style.closed&&(t=e.hypot(n.x-o.x,n.y-o.y));for(var a=0;a<this.points.length-1;a++){var l=this.points[a],r=this.points[a+1];t+=e.hypot(l.x-r.x,l.y-r.y)}return t},e.hypot=function(e,t){return o(e*e+t*t)},e.prototype.alignPoint=function(e,n){e=(e+this.points.length)%this.points.length;var o=this.points[e],i=o.x,a=o.y,l=this.points[(e+1)%this.points.length];if(t(l.x-o.x)<=n&&(i=l.x),t(l.y-o.y)<=n&&(a=l.y),2<this.points.length){var r=this.points[(e-1+this.points.length)%this.points.length];t(r.x-o.x)<=n&&(i=r.x),t(r.y-o.y)<=n&&(a=r.y)}return new I(i,a)},e}(),B=/** @class */function(){function e(e){this._closed=e.closed,this._lineWidth=e.lineWidth,this._fill=e.fill,this._fillColor=m.findByName(e.fillColorName),this._fillAlpha=u.findByName(e.fillAlphaName),this._fillString=t(this._fillColor,this._fillAlpha),this._stroke=e.stroke,this._strokeColor=m.findByName(e.strokeColorName),this._strokeAlpha=u.findByName(e.strokeAlphaName),this._strokeString=t(this._strokeColor,this._strokeAlpha)}return Object.defineProperty(e.prototype,"closed",{get:function(){return this._closed},set:function(e){this._closed=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineWidth",{get:function(){return this._lineWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fill",{get:function(){return this._fill},set:function(e){this._fill=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillColor",{get:function(){return this._fillColor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillAlpha",{get:function(){return this._fillAlpha},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillString",{get:function(){return this._fillString},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stroke",{get:function(){return this._stroke},set:function(e){this._stroke=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokeColor",{get:function(){return this._strokeColor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokeAlpha",{get:function(){return this._strokeAlpha},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokeString",{get:function(){return this._strokeString},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onScreen",{get:function(){return this._lineWidth.onScreen},set:function(e){this._lineWidth.onScreen=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onCanvas",{get:function(){return this._lineWidth.onCanvas},set:function(e){this._lineWidth.onCanvas=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ofScreen",{get:function(){return this._lineWidth.ofScreen},set:function(e){this._lineWidth.ofScreen=e},enumerable:!0,configurable:!0}),e.prototype.pack=function(){return new P(null,this._closed,this._lineWidth,this._fill,this._fillColor.name,this._fillAlpha.name,this._stroke,this._strokeColor.name,this._strokeAlpha.name)},e.prototype.setFillColor=function(e,n){this._fillColor=e,this._fillAlpha=n,this._fillString=t(this._fillColor,this._fillAlpha)},e.prototype.setStrokeColor=function(e,n){this._strokeColor=e,this._strokeAlpha=n,this._strokeString=t(this._strokeColor,this._strokeAlpha)},e}(),R=/** @class */function(t){function n(e){var n=t.call(this)||this;return n.canvasAABB=new S,n.valid=!1,n.points=e.points,n.style=new B(e),n.picker=new L(n,n.points),n.editor=new N(n,n.points),n.calculator=new A(n,n.points),n}return e(n,t),n.prototype.clone=function(e,t){void 0===e&&(e=0),void 0===t&&(t=0);for(var n,o=[],i=0,a=this.points;i<a.length;i++)n=a[i],o.push(new I(n.x+e,n.y+t));var l=this.style.pack();return l.points=o,l},n.prototype.pack=function(){var e=this.style.pack();return e.points=this.points,e},n.prototype.invalidate=function(){this.valid=!1},n.prototype.validate=function(){this.valid||this.calculator.aabb(this.canvasAABB)},n.prototype.render=function(e,t,n){this.validate();var o=n.canvasAABBInScreen(this.canvasAABB);o&&(t.setFillColor(this.style.fillString),t.setStrokeColor(this.style.strokeString),t.renderPolyline(n,this.points,this.style.closed,this.style.fill,this.style.stroke,this.style.lineWidth))},n}(b),X=/** @class */function(t){function n(e){var n=t.call(this,T.POLYLINE_VIEW,e)||this;return n.polylines=[],n}return e(n,t),n.prototype.loadData=function(t){if(this.polylines=[],t.polylines)for(var n,o=0,i=t.polylines;o<i.length;o++)n=i[o],this.polylines.push(new R(n));//listen to mouse click to select polyline
var a=this;this._mouseListener=new(/** @class */function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.moved=!1,e}return e(n,t),n.prototype.onmousedown=function(){return this.moved=!1,!1},n.prototype.onmouseup=function(e){if(0==e.button&&!this.moved){for(var t=a.camera.screenSizeToCanvas(5),n=a.camera.screenXyToCanvas(e.offsetX,e.offsetY),o=n.x,i=n.y,l=null,r=0,s=a.polylines;r<s.length;r++){var p=s[r],d=p.picker.pickPoint(o,i,t),y=p.picker.pickLine(o,i,t),c=p.picker.pickShape(o,i);(null!=d||y||c)&&(l=p)}return l?(_.select(T.POLYLINE_EDIT,l),!0):(_.deselect(T.POLYLINE_CREATE),_.deselect(T.POLYLINE_EDIT),!1)}return!1},n.prototype.onmousemove=function(e){return 1&e.buttons&&0!=e.movementX&&0!=e.movementY&&(this.moved=!0),!1},n}(E))},n.prototype.addPolyline=function(e){this.polylines.push(e),this.canvas.requestRender()},n.prototype.deletePolyline=function(e){var t=this.polylines.indexOf(e);return-1!==t&&(this.polylines.splice(t,1),!0)},n.prototype.containPolyline=function(e){return 0<=this.polylines.indexOf(e)},n.prototype.saveData=function(e){e.polylines=[];for(var t,n=0,o=this.polylines;n<o.length;n++)t=o[n],e.polylines.push(t.pack())},n.prototype.render=function(e){t.prototype.render.call(this,e);for(var n,o=0,i=this.polylines;o<i.length;o++)n=i[o],n.render(this.canvas,e,this.camera)},n.prototype.unload=function(){t.prototype.unload.call(this)},n}(v),D=/** @class */function(t){function i(e){var n=t.call(this,T.POLYLINE_EDIT,e)||this;n.polylineEdit=null;return _.register(T.POLYLINE_EDIT,function(e){n.startEditingPolyline(e)},function(){n.finishEditing()}),n}return e(i,t),i.prototype.loadMap=function(e){this.map=e},i.prototype.loadData=function(){this.layerView=this.canvas.findLayer(T.POLYLINE_VIEW),this.polylineEdit=null,this.finishEditing(),h.setVisibility("panelPolylineSelected",!1)},i.prototype.startEditingPolyline=function(t){var n=this;this.finishEditing(),this.polylineEdit=t,this.bindPolylineConfigUi(this.polylineEdit),h.setContent(i.HINT_ELEMENT_ID,i.HINT_EDIT_POLYLINE);//start listening to mouse events: drag point, remove point on double click, add point on double click
var o=this;this._mouseListener=new(/** @class */function(n){function a(){var e=null!==n&&n.apply(this,arguments)||this;return e.down=!1,e.moved=!1,e.dragPointIndex=null,e.dragShape=!1,e.dragShapeX=-1,e.dragShapeY=-1,e}return e(a,n),a.prototype.onmousedown=function(e){if(this.dragPointIndex=null,0==e.button){this.down=!0;//test point
var n=o.camera.screenXyToCanvas(e.offsetX,e.offsetY),i=t.picker.pickPoint(n.x,n.y,o.camera.screenSizeToCanvas(5));if(null!=i)return this.dragPointIndex=i,!0;var a=t.picker.pickShape(n.x,n.y);if(null==i&&a&&e.altKey){if(e.ctrlKey){var l=new R(t.clone());o.layerView.addPolyline(l)}this.dragShape=!0,this.dragShapeX=n.x,this.dragShapeY=n.y}}else 2==e.button&&(this.moved=!1);return!1},a.prototype.onmouseup=function(e){var n=null!=this.dragPointIndex||!!this.dragShape;//pass event if not dragging, so that LayerPolylineView will deselect this polyline
if(this.dragPointIndex=null,this.dragShape=!1,this.dragShapeX=-1,this.dragShapeY=-1,0==e.button)return this.down=!1,n;if(2==e.button){var i=!1;if(!this.moved){var a=o.camera.screenXyToCanvas(e.offsetX,e.offsetY),l=t.picker.pickPoint(a.x,a.y,o.camera.screenSizeToCanvas(5));//test points
null!=l&&(3<t.editor.pointCount()&&(t.editor.removePoint(l),o.canvas.requestRender()),i=!0)}return this.moved=!1,i}return!1},a.prototype.ondblclick=function(e){if(0==e.button){var n=o.camera.screenXyToCanvas(e.offsetX,e.offsetY),i=t.picker.pickPoint(n.x,n.y,o.camera.screenSizeToCanvas(5));//test points
if(null!=i)return 3<t.editor.pointCount()&&(t.editor.removePoint(i),o.canvas.requestRender()),!0;//test segments
var a=t.picker.pickLine(n.x,n.y,o.camera.screenSizeToCanvas(5));if(a){//add point
var l=a.p1Index;//insert point after p1
return t.editor.insertPoint(a.position.x,a.position.y,l),o.canvas.requestRender(),!0}}return!1},a.prototype.onmousemove=function(e){if(this.down){//left button is down => drag
var n=o.camera.screenXyToCanvas(e.offsetX,e.offsetY);if(null!=this.dragPointIndex){if(t.editor.setPoint(this.dragPointIndex,n.x,n.y),e.ctrlKey){var a=o.camera.screenSizeToCanvas(i.MAG_RADIUS),l=t.calculator.alignPoint(this.dragPointIndex,a);t.editor.setPoint(this.dragPointIndex,l.x,l.y)}return o.canvas.requestRender(),!0}if(this.dragShape)return t.editor.move(n.x-this.dragShapeX,n.y-this.dragShapeY),this.dragShapeX=n.x,this.dragShapeY=n.y,o.canvas.requestRender(),!0}else 2&e.buttons&&(this.moved=!0);return!1},a}(E)),this._keyboardListener=h.createPolylineKeyboardListener(o.canvas,o.camera,o.polylineEdit,function(){n.deleteEditing()}),this.canvas.requestRender()},i.prototype.finishEditing=function(){h.setVisibility("panelPolylineSelected",!1),this.polylineEdit&&(this.polylineEdit=null,this.canvas.requestRender()),this._mouseListener=null,this._keyboardListener=null},i.prototype.render=function(e){var t=this;this.polylineEdit&&this.polylineEdit.editor.forEachPoint(function(n,o){t.drawPointCircle(n,o,e)})},i.prototype.drawPointCircle=function(e,t,n){var o=this.camera.canvasToScreen(e,t);n.setColor("rgba(255,255,255,1)"),n.drawCircle(o.x,o.y,5,!1,!0,1),n.setColor("rgba(0,0,0,0.5)"),n.drawCircle(o.x,o.y,4,!0,!1)},i.prototype.deleteEditing=function(){this.polylineEdit&&(this.layerView.deletePolyline(this.polylineEdit),this.finishEditing())},i.prototype.bindPolylineConfigUi=function(e){var t=this;h.setVisibility("panelPolylineSelected",!0),h.bindButtonOnClick("polylineButtonCopy",function(){var n=t.canvas.getCamera().screenSizeToCanvas(20),o=new R(e.clone(n,n));t.finishEditing(),t.layerView.addPolyline(o),t.startEditingPolyline(o),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonArea",function(){if(h.setContent("polylineTextArea",""),e.style.fill){var i=t.map.widthMillimeter,a=t.map.heightMillimeter,l="mm^2";0<t.map.widthMillimeter&&0<t.map.heightMillimeter||(i=t.map.width,a=t.map.height,l="pixels");var r=e.calculator.area(),s=r/t.map.width/t.map.height*i*a;s=n(100*s)/100,h.setContent("polylineTextArea",s+l)}else{var i=t.map.widthMillimeter,a=t.map.heightMillimeter,l="mm";0<t.map.widthMillimeter&&0<t.map.heightMillimeter||(i=t.map.width,a=t.map.height,l="pixels");var p=e.calculator.length(),d=p*o(i*a/t.map.width/t.map.height);d=n(100*d)/100,h.setContent("polylineTextArea",d+l)}}),h.setContent("polylineTextArea",""),h.bindButtonOnClick("polylineButtonRotateCCW",function(){e.editor.rotateCCW(),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonRotateCW",function(){e.editor.rotateCW(),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonFlipX",function(){e.editor.flipX(),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonFlipY",function(){e.editor.flipY(),t.canvas.requestRender()}),h.bindCheckbox("polylineCheckboxFill",e.style.fill,function(n){e.style.fill=n,t.canvas.requestRender()}),h.bindCheckbox("polylineCheckboxStroke",e.style.stroke,function(n){e.style.stroke=n,t.canvas.requestRender()}),h.bindCheckbox("polylineCheckboxClosed",e.style.closed,function(n){e.style.closed=n,t.canvas.requestRender()}),h.bindNumber("polylineTextSizeOnScreen",e.style.onScreen,function(n){e.style.onScreen=n,t.canvas.requestRender()}),h.bindNumber("polylineTextSizeOnCanvas",e.style.onCanvas,function(n){e.style.onCanvas=n,t.canvas.requestRender()}),h.bindNumber("polylineTextSizeOfScreen",1e3*e.style.ofScreen,function(n){e.style.ofScreen=.001*n,t.canvas.requestRender()}),h.bindColor("polylineContainerStrokeColor","polylineContainerStrokeAlpha",e.style.strokeColor,e.style.strokeAlpha,function(n,o){e.style.setStrokeColor(n,o),t.canvas.requestRender()}),h.bindColor("polylineContainerFillColor","polylineContainerFillAlpha",e.style.fillColor,e.style.fillAlpha,function(n,o){e.style.setFillColor(n,o),t.canvas.requestRender()})},i.HINT_ELEMENT_ID="hint",i.HINT_EDIT_POLYLINE="1. hold left button to drag points<br>2. hold ctrl to help with horizontal/vertical line<br>3. hold alt to drag polyline<br>4. hold ctrl+alt to copy and drag polyline<br>5. double click on line to create point<br>6. right-click / double left-click point to delete it<br>",i.MAG_RADIUS=10,i}(v),M=/** @class */function(){return function(e,t,n,// anchorX: CanvasTextAlign, anchorY: CanvasTextBaseline,
o,i,a){this.text="",this.text=e,this.colorName=t,this.alphaName=n,this.fontSize=o,this.x=i,this.y=a}}(),q=/** @class */function(n){function o(e){var o=n.call(this)||this;return o._text="",o._canvasAABB=new S,o.sizeValid=!1,o.canvasZoom=-1,o.canvasWidth=0,o.canvasHeight=0,o.screenWidth=0,o.screenHeight=0,o._text=e.text,o.color=m.findByName(e.colorName),o.alpha=u.findByName(e.alphaName),o.colorString=t(o.color,o.alpha),o.fontSize=e.fontSize,o._x=e.x,o._y=e.y,o}return e(o,n),o.prototype.invalidate=function(){this.sizeValid=!1},Object.defineProperty(o.prototype,"text",{get:function(){return this._text},set:function(e){this._text=e,this.invalidate()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),o.prototype.validateCanvasAABB=function(e,t){return this.validate(e,t),this._canvasAABB},Object.defineProperty(o.prototype,"onScreen",{get:function(){return this.fontSize.onScreen},set:function(e){this.fontSize.onScreen=e,this.invalidate()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"onCanvas",{get:function(){return this.fontSize.onCanvas},set:function(e){this.fontSize.onCanvas=e,this.invalidate()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"ofScreen",{get:function(){return this.fontSize.ofScreen},set:function(e){this.fontSize.ofScreen=e,this.invalidate()},enumerable:!0,configurable:!0}),o.prototype.setPosition=function(e,t){this._x=e,this._y=t,this.invalidate()},o.prototype.setColorAlpha=function(e,n){this.color=e,this.alpha=n,this.colorString=t(this.color,this.alpha)},o.prototype.clone=function(e,t){return new M(this._text,this.color.name,this.alpha.name,this.fontSize,this._x+e,this._y+t)},o.prototype.pack=function(){return new M(this._text,this.color.name,this.alpha.name,this.fontSize,this._x,this._y)},o.prototype.render=function(e,t,n){t.setColor(this.colorString),this.validate(n,t);var o=n.canvasAABBInScreen(this._canvasAABB);o&&t.renderText(n,this._text,this.screenHeight,this._x,this._y,"center","middle")},o.prototype.validate=function(e,t){if(!this.sizeValid||this.canvasZoom!=e.getZoom()){this.sizeValid=!0;var n=t.measureText(e,this._text,this.fontSize),o=e.screenSizeToCanvas(1);this.canvasZoom=e.getZoom(),this.canvasWidth=n[0]*o/2,this.canvasHeight=n[1]*o/2,this.screenWidth=n[0],this.screenHeight=n[1],this.calcCanvasAABB()}},o.prototype.pick=function(e,t,n){var o=this._x-this.canvasWidth-n<=e&&e<=this._x+this.canvasWidth+n,i=this._y-this.canvasHeight-n<=t&&t<=this._y+this.canvasHeight+n;return o&&i},o.prototype.calcCanvasAABB=function(){return this._canvasAABB.x1=this.x-this.canvasWidth,this._canvasAABB.y1=this.y-this.canvasHeight,this._canvasAABB.x2=this.x+this.canvasWidth,this._canvasAABB.y2=this.y+this.canvasHeight,this._canvasAABB},o}(b),O=/** @class */function(t){function n(e){var n=t.call(this,T.TEXT_EDIT,e)||this;n.textEdit=null;var o=n;return _.register(T.TEXT_EDIT,function(e){o.startEditingText(e)},function(){o.finishEditing()}),n}return e(n,t),n.prototype.loadData=function(){this.layerView=this.canvas.findLayer(T.TEXT_VIEW),this.finishEditing(),h.setVisibility("panelTextSelected",!1)},n.prototype.startEditingText=function(t){var o=this;this.finishEditing(),this.textEdit=t,this.bindTextConfigUi(this.textEdit),h.setContent(n.HINT_ELEMENT_ID,n.HINT_EDIT_TEXT);//start listening to mouse events: drag point, remove point on double click, add point on double click
var i=this;this._mouseListener=new(/** @class */function(n){function o(){var e=null!==n&&n.apply(this,arguments)||this;return e.down=!1,e.drag=!1,e.dragX=0,e.dragY=0,e}return e(o,n),o.prototype.onmousedown=function(e){if(0==e.button){this.down=!0,this.drag=!1;//test
var n=i.camera.screenXyToCanvas(e.offsetX,e.offsetY),o=t.pick(n.x,n.y,i.camera.screenSizeToCanvas(5));if(o&&e.altKey){//start dragging
if(e.ctrlKey){var a=new q(t.clone(0,0));i.layerView.addText(a)}return this.drag=!0,this.dragX=n.x-t.x,this.dragY=n.y-t.y,e.altKey}}return!1},o.prototype.onmouseup=function(e){var t=!this.drag;//pass event if not moving point, so that LayerTextView will deselect this text
return this.drag=!1,0==e.button&&(this.down=!1,!t)},o.prototype.onmousemove=function(e){if(this.down&&this.drag){var t=i.camera.screenXyToCanvas(e.offsetX,e.offsetY);return i.textEdit.setPosition(t.x-this.dragX,t.y-this.dragY),i.canvas.requestRender(),!0}return!1},o}(E)),this._keyboardListener=h.createTextKeyboardListener(i.canvas,i.camera,i.textEdit,function(){o.deleteEditing()}),this.canvas.requestRender()},n.prototype.finishEditing=function(){h.setVisibility("panelTextSelected",!1),this.textEdit&&(0==this.textEdit.text.length&&this.layerView.deleteText(this.textEdit),this.textEdit=null,this.canvas.requestRender()),this._mouseListener=null,this._keyboardListener=null},n.prototype.render=function(e){if(this.textEdit){e.setColor(this.textEdit.colorString);var t=this.textEdit.validateCanvasAABB(this.camera,e),n=this.camera.canvasToScreen(t.x1,t.y1),o=this.camera.canvasToScreen(t.x2,t.y2);e.drawRect(n.x-5,n.y-5,o.x+5,o.y+5,!1,!0,2)}},n.prototype.deleteEditing=function(){this.textEdit&&(this.layerView.deleteText(this.textEdit),this.finishEditing())},n.prototype.bindTextConfigUi=function(e){var t=this;h.setVisibility("panelTextSelected",!0),h.bindButtonOnClick("textButtonCopy",function(){var n=t.canvas.getCamera().screenSizeToCanvas(10),o=new q(e.clone(n,n));t.finishEditing(),t.layerView.addText(o),t.startEditingText(o),t.canvas.requestRender()}),h.bindValue("textTextContent",e.text,function(n){e.text=n,t.canvas.requestRender()}),h.bindNumber("textTextSizeOnScreen",e.onScreen,function(n){e.onScreen=n,t.canvas.requestRender()}),h.bindNumber("textTextSizeOnCanvas",e.onCanvas,function(n){e.onCanvas=n,t.canvas.requestRender()}),h.bindNumber("textTextSizeOfScreen",1e3*e.ofScreen,function(n){e.ofScreen=.001*n,t.canvas.requestRender()}),h.bindColor("textContainerColor","textContainerAlpha",e.color,e.alpha,function(n,o){e.setColorAlpha(n,o),t.canvas.requestRender()})},n.HINT_ELEMENT_ID="hint",n.HINT_EDIT_TEXT="1. hold alt to drag<br>2. hold ctrl+alt to copy and drag <br>",n}(v),z=/** @class */function(t){function n(e){var n=t.call(this,T.TEXT_VIEW,e)||this;return n.texts=[],n}return e(n,t),n.prototype.loadData=function(t){if(this.texts=[],t.texts)for(var n,o=0,i=t.texts;o<i.length;o++)n=i[o],this.texts.push(new q(n));//listen to mouse click to select text
var a=this;this._mouseListener=new(/** @class */function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.moved=!1,e}return e(n,t),n.prototype.onmousedown=function(){return this.moved=!1,!1},n.prototype.onmouseup=function(e){if(0==e.button&&!this.moved){for(var t=a.camera.screenXyToCanvas(e.offsetX,e.offsetY),n=t.x,o=t.y,i=null,l=0,r=a.texts;l<r.length;l++){var s=r[l],p=s.pick(n,o,a.camera.screenSizeToCanvas(5));p&&(i=s)}return i?(_.select(T.TEXT_EDIT,i),!0):(_.deselect(T.TEXT_CREATE),_.deselect(T.TEXT_EDIT),!1)}return!1},n.prototype.onmousemove=function(e){return 1&e.buttons&&0!=e.movementX&&0!=e.movementY&&(this.moved=!0),!1},n}(E))},n.prototype.addText=function(e){this.texts.push(e),this.canvas.requestRender()},n.prototype.deleteText=function(e){var t=this.texts.indexOf(e);return-1!==t&&(this.texts.splice(t,1),!0)},n.prototype.saveData=function(e){e.texts=[];for(var t,n=0,o=this.texts;n<o.length;n++)t=o[n],e.texts.push(t.pack())},n.prototype.render=function(e){t.prototype.render.call(this,e);for(var n,o=0,i=this.texts;o<i.length;o++)n=i[o],n.render(this.canvas,e,this.camera)},n.prototype.unload=function(){t.prototype.unload.call(this)},n}(v),Y=/** @class */function(){function e(){}return e.getComments=function(e,t,n){f.get("https://api.github.com/repos/"+e+"/issues/"+t+"/comments",function(e){try{var t=JSON.parse(e);n(t)}catch(t){}})},e.getIssueLink=function(e,t){return"https://github.com/"+e+"/issues/"+t},e.getCommentLink=function(e,t,n){return"https://github.com/"+e+"/issues/"+t+"#issuecomment-"+n},e}(),V=/** @class */function(){return function(e,t,n){this.onScreen=e,this.onCanvas=t?t:0,this.ofScreen=n?n:0}}(),W=/** @class */function(t){function i(e){var n=t.call(this,T.POLYLINE_CREATE,e)||this;return n.polylineNew=null,_.register(T.POLYLINE_CREATE,function(){n.startCreatingPolyline()},function(){n.finishEditing()}),n}return e(i,t),i.prototype.loadMap=function(e){this.map=e},i.prototype.loadData=function(){this.layerView=this.canvas.findLayer(T.POLYLINE_VIEW),this.polylineNew=null,this.finishEditing(),h.setVisibility("panelPolylineSelected",!1)},i.prototype.createPolylineAndEdit=function(){this.polylineNew=new R(new P([],!0,new V(2),!0,"white","25",!0,"white","75")),_.select(T.POLYLINE_CREATE,this.polylineNew)},i.prototype.startCreatingPolyline=function(){var t=this,n=this;return this.bindPolylineConfigUi(this.polylineNew),h.setContent(i.HINT_ELEMENT_ID,i.HINT_NEW_POLYLINE),this._mouseListener=new(/** @class */function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.down=!1,e.moved=!1,e}return e(o,t),o.prototype.preview=function(e,t){if(n.polylineNew.editor.setPoint(-1,e.x,e.y),t){var o=n.camera.screenSizeToCanvas(i.MAG_RADIUS),a=n.polylineNew.calculator.alignPoint(-1,o);n.polylineNew.editor.setPoint(-1,a.x,a.y)}},o.prototype.onmousedown=function(e){if(0==e.button&&!this.down){this.down=!0;var t=n.camera.screenXyToCanvas(e.offsetX,e.offsetY);return n.polylineNew.editor.addPoint(t.x,t.y),n.canvas.requestRender(),!0}return 2==e.button&&(this.moved=!1),!1},o.prototype.onmouseup=function(e){if(0==e.button){this.down=!1;var t=n.camera.screenXyToCanvas(e.offsetX,e.offsetY);return this.preview(t,e.ctrlKey),n.canvas.requestRender(),!0}if(2==e.button){if(!this.moved){var o=n.polylineNew;n.finishEditing(),n.layerView.containPolyline(o)&&_.select(T.POLYLINE_EDIT,o)}return this.moved=!1,!0}return!1},o.prototype.onmousemove=function(e){if(this.down){//left button is down => show modification
var t=n.camera.screenXyToCanvas(e.offsetX,e.offsetY);return this.preview(t,e.ctrlKey),n.canvas.requestRender(),!0}return 2&e.buttons&&(this.moved=!0),!1},o}(E)),this._keyboardListener=h.createPolylineKeyboardListener(n.canvas,n.camera,n.polylineNew,function(){t.deleteCreating()}),this.polylineNew},i.prototype.deleteCreating=function(){this.polylineNew=null,this.finishEditing(),this.canvas.requestRender()},i.prototype.finishEditing=function(){h.setVisibility("panelPolylineSelected",!1),this.polylineNew&&(2<this.polylineNew.editor.pointCount()&&this.layerView.addPolyline(this.polylineNew),this.polylineNew=null,this.canvas.requestRender()),this._mouseListener=null,this._keyboardListener=null},i.prototype.render=function(e){if(this.polylineNew){this.polylineNew.render(this.canvas,e,this.camera);//draw two points
var t=this.polylineNew.editor.pointCount();if(0<t){var n=this.polylineNew.editor.getPoint(0);this.drawPointCircle(n.x,n.y,e)}if(1<t){var n=this.polylineNew.editor.getPoint(-1);this.drawPointCircle(n.x,n.y,e)}}},i.prototype.drawPointCircle=function(e,t,n){var o=this.camera.canvasToScreen(e,t);n.setColor("rgba(255,255,255,1)"),n.drawCircle(o.x,o.y,5,!1,!0,1),n.setColor("rgba(0,0,0,0.5)"),n.drawCircle(o.x,o.y,4,!0,!1)},i.prototype.bindPolylineConfigUi=function(e){var t=this;h.setVisibility("panelPolylineSelected",!0),h.bindButtonOnClick("polylineButtonCopy",function(){var n=t.canvas.getCamera().screenSizeToCanvas(20),o=new R(e.clone(n,n));t.finishEditing(),t.layerView.addPolyline(o),_.select("polylinecreate",o),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonArea",function(){if(h.setContent("polylineTextArea",""),e.style.fill){var i=t.map.widthMillimeter,a=t.map.heightMillimeter,l="mm^2";0<t.map.widthMillimeter&&0<t.map.heightMillimeter||(i=t.map.width,a=t.map.height,l="pixels");var r=e.calculator.area(),s=r/t.map.width/t.map.height*i*a;s=n(100*s)/100,h.setContent("polylineTextArea",s+l)}else{var i=t.map.widthMillimeter,a=t.map.heightMillimeter,l="mm";0<t.map.widthMillimeter&&0<t.map.heightMillimeter||(i=t.map.width,a=t.map.height,l="pixels");var p=e.calculator.length(),d=p*o(i*a/t.map.width/t.map.height);d=n(100*d)/100,h.setContent("polylineTextArea",d+l)}}),h.setContent("polylineTextArea",""),h.bindButtonOnClick("polylineButtonRotateCCW",function(){e.editor.rotateCCW(),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonRotateCW",function(){e.editor.rotateCW(),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonFlipX",function(){e.editor.flipX(),t.canvas.requestRender()}),h.bindButtonOnClick("polylineButtonFlipY",function(){e.editor.flipY(),t.canvas.requestRender()}),h.bindCheckbox("polylineCheckboxFill",e.style.fill,function(n){e.style.fill=n,t.canvas.requestRender()}),h.bindCheckbox("polylineCheckboxStroke",e.style.stroke,function(n){e.style.stroke=n,t.canvas.requestRender()}),h.bindCheckbox("polylineCheckboxClosed",e.style.closed,function(n){e.style.closed=n,t.canvas.requestRender()}),h.bindNumber("polylineTextSizeOnScreen",e.style.onScreen,function(n){e.style.onScreen=n,t.canvas.requestRender()}),h.bindNumber("polylineTextSizeOnCanvas",e.style.onCanvas,function(n){e.style.onCanvas=n,t.canvas.requestRender()}),h.bindNumber("polylineTextSizeOfScreen",1e3*e.style.ofScreen,function(n){e.style.ofScreen=.001*n,t.canvas.requestRender()}),h.bindColor("polylineContainerStrokeColor","polylineContainerStrokeAlpha",e.style.strokeColor,e.style.strokeAlpha,function(n,o){e.style.setStrokeColor(n,o),t.canvas.requestRender()}),h.bindColor("polylineContainerFillColor","polylineContainerFillAlpha",e.style.fillColor,e.style.fillAlpha,function(n,o){e.style.setFillColor(n,o),t.canvas.requestRender()})},i.HINT_ELEMENT_ID="hint",i.HINT_NEW_POLYLINE="1. left click to create point<br>2. hold left button to preview point<br>3. right click to finish creating<br>4. hold ctrl to help with horizontal/vertical line<br>",i.MAG_RADIUS=10,i}(v),H=/** @class */function(t){function n(e){var n=t.call(this,T.TEXT_CREATE,e)||this;return _.register(T.TEXT_CREATE,function(){n.startCreatingText()},function(){n.finishCreating()}),n}return e(n,t),n.prototype.loadData=function(){this.layerView=this.canvas.findLayer(T.TEXT_VIEW),this.finishCreating(),h.setVisibility("panelTextSelected",!1)},n.prototype.createTextAndEdit=function(){this.textNew=new q(new M("text","white","100",new V(5,50),0,0)),_.select(T.TEXT_CREATE,this.textNew)},n.prototype.startCreatingText=function(){var t=this;this.finishCreating();var o=this;this.bindTextConfigUi(this.textNew),h.setContent(n.HINT_ELEMENT_ID,n.HINT_NEW_TEXT),this._mouseListener=new(/** @class */function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.down=!1,e}return e(n,t),n.prototype.onmousedown=function(e){return 0==e.button&&(this.down=!0,!0)},n.prototype.onmouseup=function(e){if(0==e.button){this.down=!1;var t=o.camera.screenXyToCanvas(e.offsetX,e.offsetY);return o.textNew.setPosition(t.x,t.y),o.layerView.addText(o.textNew),_.select(T.TEXT_EDIT,o.textNew),o.canvas.requestRender(),!0}return!1},n.prototype.onmousemove=function(e){return 1&e.buttons&&this.down},n}(E)),this._keyboardListener=h.createTextKeyboardListener(o.canvas,o.camera,o.textNew,function(){t.deleteCreating()})},n.prototype.finishCreating=function(){h.setVisibility("panelTextSelected",!1),this._mouseListener=null,this._keyboardListener=null},n.prototype.render=function(){},n.prototype.deleteCreating=function(){this.textNew&&(this.layerView.deleteText(this.textNew),this.textNew=null,this.finishCreating())},n.prototype.bindTextConfigUi=function(e){var t=this;h.setVisibility("panelTextSelected",!0),h.bindButtonOnClick("textButtonCopy",function(){}),h.bindValue("textTextContent",e.text,function(n){e.text=n,t.canvas.requestRender()}),h.bindNumber("textTextSizeOnScreen",e.onScreen,function(n){e.onScreen=n,t.canvas.requestRender()}),h.bindNumber("textTextSizeOnCanvas",e.onCanvas,function(n){e.onCanvas=n,t.canvas.requestRender()}),h.bindNumber("textTextSizeOfScreen",1e3*e.ofScreen,function(n){e.ofScreen=.001*n,t.canvas.requestRender()}),h.bindColor("textContainerColor","textContainerAlpha",e.color,e.alpha,function(n,o){e.setColorAlpha(n,o),t.canvas.requestRender()})},n.HINT_ELEMENT_ID="hint",n.HINT_NEW_TEXT="1. left click to create text<br>",n}(v);document.getElementById("panel").style.display=h.isMobile()?"none":"block";var Z=new x(document.getElementById("container"),"canvas2d");Z.init();var F=new k(Z),U=new X(Z),K=new W(Z),G=new D(Z),j=new z(Z),J=new H(Z),Q=new O(Z);Z.addLayer(F),Z.addLayer(U),Z.addLayer(G),Z.addLayer(K),Z.addLayer(j),Z.addLayer(Q),Z.addLayer(J),h.bindButtonOnClick("buttonNewPolyline",function(){Q.finishEditing(),K.createPolylineAndEdit()}),h.bindButtonOnClick("polylineButtonDelete",function(){G.deleteEditing(),K.deleteCreating(),Q.finishEditing(),G.finishEditing()}),h.bindButtonOnClick("buttonNewText",function(){G.finishEditing(),J.createTextAndEdit()}),h.bindButtonOnClick("textButtonDelete",function(){G.finishEditing(),J.deleteCreating(),J.finishCreating(),Q.deleteEditing(),Q.finishEditing()});var $=/** @class */function(){function e(){this.currentChip=null,this.issueLink="",this.currentCommentId=0,this.dummyData=null}return e.prototype.start=function(){var e=this;f.get("https://misdake.github.io/ChipAnnotationData/list.json",function(t){var n=JSON.parse(t),o={},i=[],a=[],l={},r=[];if(n&&n.length)for(var s=0,p=n;s<p.length;s++){var d=p[s],y=d.vendor+" "+d.type+" "+d.family+" "+d.name;r.push(y),l[y]=d,o[d.name]=d}r.sort();for(var c="",m="",u=0,g=r;u<g.length;u++){var x=g[u],d=l[x],f=d.vendor+" "+d.type,v=""+d.family;c!==f&&f&&f.length&&(i.push(f),a.push(null)),m!==v&&v&&v.length&&(i.push("\xA0\xA0\xA0\xA0"+v),a.push(null)),i.push("\xA0\xA0\xA0\xA0\xA0\xA0\xA0\xA0"+d.name),a.push(d),c=f,m=v}var b=window.location.href,C=new URL(b),E=C.searchParams.get("map")||"Fiji",_=C.searchParams.get("commentId")||"0";e.currentCommentId=parseInt(_),h.bindSelect("mapSelect",i,"\xA0\xA0\xA0\xA0\xA0\xA0\xA0\xA0"+E,function(t){e.currentCommentId=0;var n=a[t];n&&(e.loadMap(n),e.replaceUrl())}),e.loadMap(o[E])})},e.prototype.loadMap=function(e){var t=this;this.currentChip=e,f.get(e.url+"/content.json",function(e){var n=JSON.parse(e);Z.loadMap(n),Z.requestRender(),t.issueLink=Y.getIssueLink(n.githubRepo,n.githubIssueId),h.bindButtonOnClick("buttonSave",function(){Q.finishEditing(),G.finishEditing();var e=Z.save();e.title=document.getElementById("dataTitle").value,(null==e.title||""==e.title)&&(e.title="untitled");var n=JSON.stringify(e);h.bindValue("dataOutput",n,function(){}),h.copyToClipboard("dataOutput"),h.bindValue("dataOutput","",function(){}),t.issueLink&&window.open(t.issueLink,"_blank")}),h.bindValue("dataOutput","",function(){}),h.bindValue("dataTitle","",function(){}),h.bindSelect("dataSelect",[],null,function(){}),t.dummyData=new y,t.dummyData.title="",Z.loadData(t.dummyData),h.bindValue("dataOutput","",function(){}),t.loadGithubComment(n,t.currentCommentId),h.bindButtonOnClick("buttonRefreshData",function(){t.loadGithubComment(n,t.currentCommentId)})})},e.prototype.loadGithubComment=function(e,t){var n=this;e.githubRepo&&e.githubIssueId&&Y.getComments(e.githubRepo,e.githubIssueId,function(o){var i=[],a=[],l=[];i.push(null),a.push(n.dummyData),l.push("dummy");for(var r,s=0,p=n.dummyData,d=0,y=0,c=o;y<c.length;y++){r=c[y];try{var m=JSON.parse(r.body);null!=m.polylines&&null!=m.texts&&((null==m.title||""==m.title)&&(m.title="untitled"),i.push(r),a.push(m),l.push(m.title+" by "+r.user.login),t==r.id&&(s=i.length-1,p=m,d=r.id))}catch(t){}}l[0]="(total: "+(l.length-1)+")",h.bindSelect("dataSelect",l,l[s],function(t){var o=i[t],l=a[t];n.loadData(e,l,o?o.id:0)}),n.loadData(e,p,d)})},e.prototype.loadData=function(e,t,n){h.bindValue("dataTitle",t.title,function(){}),this.currentCommentId=n,this.issueLink=0<n?Y.getCommentLink(e.githubRepo,e.githubIssueId,n):Y.getIssueLink(e.githubRepo,e.githubIssueId),h.bindValue("dataOutput","",function(){}),Z.loadData(t),this.replaceUrl(),Z.requestRender()},e.prototype.replaceUrl=function(){var e=location.pathname+"?map="+this.currentChip.name;0<this.currentCommentId&&(e+="&commentId="+this.currentCommentId),history.replaceState(null,"",e)},e}();new $().start()});
