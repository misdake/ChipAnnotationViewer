(function(e){"function"==typeof define&&define.amd?define(e):e()})(function(){'use strict';var o=Math.sqrt,n=Math.max,i=Math.min;function e(e,t){function o(){this.constructor=e}m(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}function t(e,t){return"rgba("+e.r+","+e.g+","+e.b+","+t.value+")"}var a=/** @class */function(){return function(e,t,o,n){this.left=e,this.top=t,this.width=o,this.height=n}}(),r=/** @class */function(){function e(e,t,o){this.canvas=e,this.canvasElement=t,this.context=o}return e.prototype.clear=function(){this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvasElement.width,this.canvasElement.height)},e.prototype.setColor=function(e){this.context.fillStyle=e,this.context.strokeStyle=e},e.prototype.setFillColor=function(e){this.context.fillStyle=e},e.prototype.setStrokeColor=function(e){this.context.strokeStyle=e},e.prototype.calculateLineWidth=function(e,t){if(!t)return 1;var o=t.onScreen,n=e.canvasSizeToScreen(t.onCanvas),a=t.ofScreen*i(this.canvasElement.width,this.canvasElement.height);return o+n+a},e.prototype.renderPolyline=function(e,t,o,n,a,r){if(0!=t.length){this.context.lineWidth=this.calculateLineWidth(e,r),this.context.beginPath(),this.context.lineCap="round",this.context.lineJoin="round";var l=e.canvasToScreen(t[0].x,t[0].y);this.context.moveTo(l.x,l.y);for(var s,p=1;p<t.length;p++)s=e.canvasToScreen(t[p].x,t[p].y),this.context.lineTo(s.x,s.y);o&&this.context.closePath(),n&&this.context.fill(),a&&this.context.stroke()}},e.prototype.testImageVisibility=function(e,t,o,n,i,r){//transform to screen space
var l=e.canvasToScreen(o.position.x,o.position.y),s=e.canvasSizeToScreen(n),p=e.canvasSizeToScreen(i);//skip out-of-screen images
return l.x-r>this.canvas.getWidth()||l.y-r>this.canvas.getHeight()?null:0>l.x+s+r||0>l.y+p+r?null:new a(l.x,l.y,s,p)},e.prototype.renderImage=function(e,t,o,n,i){var a=this.testImageVisibility(e,t,o,n,i,0);this.drawImage(t,a)},e.prototype.drawImage=function(e,t){t&&this.context.drawImage(e,t.left,t.top,t.width,t.height)},e.prototype.renderCircle=function(e,t,o,n,i,a,r){var l=e.canvasToScreen(t,o),s=e.canvasSizeToScreen(n);this.drawCircle(l.x,l.y,s,i,a),this.context.lineWidth=this.calculateLineWidth(e,r)},e.prototype.drawCircle=function(e,t,o,n,i,a){var r=Math.PI;a&&(this.context.lineWidth=a),this.context.beginPath(),this.context.arc(e,t,o,0,2*r),this.context.closePath(),n&&this.context.fill(),i&&this.context.stroke()},e.prototype.drawRect=function(e,t,o,n,i,a,r){r&&(this.context.lineWidth=r),this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(e,n),this.context.lineTo(o,n),this.context.lineTo(o,t),this.context.closePath(),i&&this.context.fill(),a&&this.context.stroke()},e.prototype.measureText=function(e,t,o){var n=this.calculateLineWidth(e,o);this.context.font=n+"px Arial";var i=this.context.measureText(t);return[i.width,n]},e.prototype.renderText=function(e,t,o,n,i,a,r){var l=e.canvasToScreen(n,i);this.drawText(t,o,l.x,l.y,a,r)},e.prototype.drawText=function(e,t,o,n,i,a){this.context.textAlign=i,this.context.textBaseline=a,this.context.font=t+"px Arial",this.context.fillText(e,o,n)},e}(),l=/** @class */function(){return function(){this.position=new s(0,0)}}(),s=/** @class */function(){return function(e,t){this.x=e,this.y=t}}(),p=/** @class */function(){function e(){this.position=new s(0,0)}return e.prototype.load=function(e,t){this.canvas=e,this.zoomMin=0,this.zoomMax=t.maxLevel,this.zoom=t.maxLevel,this.checkZoom(),this.position.x=t.width/2,this.position.y=t.height/2,this.xMin=0,this.xMax=t.width,this.yMin=0,this.yMax=t.height},e.prototype.moveXy=function(e,t){this.position.x+=e,this.position.y+=t,this.checkXy()},e.prototype.checkXy=function(){this.position.x=i(n(this.position.x,this.xMin),this.xMax),this.position.y=i(n(this.position.y,this.yMin),this.yMax)},e.prototype.getZoom=function(){return this.zoom},e.prototype.changeZoomBy=function(e){this.zoom+=e,this.checkZoom()},e.prototype.setZoomTo=function(e){this.zoom=e,this.checkZoom()},e.prototype.checkZoom=function(){this.zoom=i(n(this.zoom,this.zoomMin),this.zoomMax)},e.prototype.action=function(){if(this.canvas){this.checkXy(),this.checkZoom();var e=1/(1<<this.zoom);this.scale=e,this.tx=this.canvas.getWidth()/2-this.position.x*e,this.ty=this.canvas.getHeight()/2-this.position.y*e}},e.prototype.screenXyToCanvas=function(e,t){var o=(e-this.tx)/this.scale,n=(t-this.ty)/this.scale;return new s(o,n)},e.prototype.canvasToScreen=function(e,t){var o=e*this.scale+this.tx,n=t*this.scale+this.ty;return new s(o,n)},e.prototype.screenSizeToCanvas=function(e){return e/this.scale},e.prototype.canvasSizeToScreen=function(e){return e*this.scale},e.prototype.canvasAABBInScreen=function(e){var t=e.x1*this.scale+this.tx,o=e.y1*this.scale+this.ty,n=e.x2*this.scale+this.tx,i=e.y2*this.scale+this.ty,a=this.canvas.getWidth(),r=this.canvas.getHeight();return!(0>n||t>a||0>i||o>r)},e}(),d=/** @class */function(){return function(){}}(),y=/** @class */function(){function e(e,t){this.renderNext=!1,this.map=null,this.data=null,this.domElement=e,this.domElement.innerHTML+="<canvas id=\""+t+"\" style='width:100%;height:100%;overflow:hidden'></canvas>",this.domElement.oncontextmenu=function(){return!1;//disable context menu
},this.canvasElement=document.getElementById(t),this.context=this.canvasElement.getContext("2d"),this.camera=new p,this.renderer=new r(this,this.canvasElement,this.context),this.width=this.canvasElement.clientWidth,this.height=this.canvasElement.clientHeight;var o=this;window.addEventListener("resize",function(){o.requestRender()})}return e.prototype.getCamera=function(){return this.camera},e.prototype.init=function(){var e=this;this.layers=[],this.canvasElement.onclick=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.mouseListener&&o.mouseListener.onclick(t)));a--);},this.canvasElement.ondblclick=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.mouseListener&&o.mouseListener.ondblclick(t)));a--);},this.canvasElement.onwheel=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.mouseListener&&o.mouseListener.onwheel(t)));a--);},this.canvasElement.onmousedown=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.mouseListener&&o.mouseListener.onmousedown(t)));a--);},this.canvasElement.onmouseup=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.mouseListener&&o.mouseListener.onmouseup(t)));a--);},this.canvasElement.onmousemove=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.mouseListener&&o.mouseListener.onmousemove(t)));a--);},this.canvasElement.onmouseout=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.mouseListener&&o.mouseListener.onmouseout(t)));a--);},this.canvasElement.onkeydown=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.keyboardListener&&o.keyboardListener.onkeydown(t)));a--);},this.canvasElement.onkeyup=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.keyboardListener&&o.keyboardListener.onkeyup(t)));a--);},this.canvasElement.onkeypress=function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();for(var o,n=e.layers.length,a=n-1;0<=a&&(o=e.layers[a],!(o.keyboardListener&&o.keyboardListener.onkeypress(t)));a--);}},e.prototype.addLayer=function(e){this.layers.push(e)},e.prototype.findLayer=function(e){for(var t,o=0,n=this.layers;o<n.length;o++)if(t=n[o],t.name==e)return t;return null},e.prototype.getWidth=function(){return this.width},e.prototype.getHeight=function(){return this.height},e.prototype.requestRender=function(){if(!this.renderNext){this.renderNext=!0;var e=this;requestAnimationFrame(function(){e.renderNext=!1,e.render()})}},e.prototype.loadMap=function(e){if(!this.map||this.map.name!=e.name){this.camera.load(this,e);for(var t,o=0,n=this.layers;o<n.length;o++)t=n[o],t.loadMap(e)}this.map=e},e.prototype.loadData=function(e){if(this.data!=e)for(var t,o=0,n=this.layers;o<n.length;o++)t=n[o],t.loadData(e);this.data=e},e.prototype.save=function(){for(var e,t=new d,o=0,n=this.layers;o<n.length;o++)e=n[o],e.saveData(t);return t},e.prototype.render=function(){this.width=this.canvasElement.clientWidth,this.height=this.canvasElement.clientHeight,this.canvasElement.width!==this.width&&(this.canvasElement.width=this.width),this.canvasElement.height!==this.height&&(this.canvasElement.height=this.height),this.camera.action(),this.renderer.clear();for(var e,t=0,o=this.layers;t<o.length;t++)e=o[t],e.render(this.renderer)},e}(),c=/** @class */function(){function e(){}return e.get=function(e,t){var o=new XMLHttpRequest;o.onreadystatechange=function(){4==o.readyState&&200==o.status&&t(o.responseText)},o.open("GET",e,!0),o.send()},e}(),m=function(e,t){return m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])},m(e,t)},u=/** @class */function(){function e(e,t){this._mouseListener=null,this._keyboardListener=null,this.name=e,this.canvas=t,this.camera=t.getCamera()}return Object.defineProperty(e.prototype,"mouseListener",{get:function(){return this._mouseListener},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"keyboardListener",{get:function(){return this._keyboardListener},enumerable:!0,configurable:!0}),e.prototype.loadMap=function(){},e.prototype.loadData=function(){},e.prototype.saveData=function(){},e.prototype.render=function(){},e.prototype.unload=function(){},e}(),g=/** @class */function(){function e(){this.transformation=new l}return e.prototype.render=function(){},e}(),h=/** @class */function(t){function o(e,o,n,i,a,r){var l=t.call(this)||this;l.transformation.position.x=o,l.transformation.position.y=n,l.w=i,l.h=a,l.img=new Image,l.src=e,l.loaded=!1;return l.img.onload=function(){l.loaded=!0,r&&r(l)},l}return e(o,t),o.prototype.loadIfNotLoaded=function(){this.loading||(this.loading=!0,this.img.src=this.src)},o.prototype.render=function(e,t,o){var n=t.testImageVisibility(o,this.img,this.transformation,this.w,this.h,100);n&&(this.loadIfNotLoaded(),this.loaded&&t.drawImage(this.img,n))},o}(g),x=/** @class */function(){function e(){}return e.prototype.onclick=function(){return!1},e.prototype.ondblclick=function(){return!1},e.prototype.onwheel=function(){return!1},e.prototype.onmousedown=function(){return!1},e.prototype.onmouseup=function(){return!1},e.prototype.onmousemove=function(){return!1},e.prototype.onmouseout=function(){return!1},e}(),f=/** @class */function(){function e(e,t,o,n){this.name=e,this.r=t,this.g=o,this.b=n}return e.findByName=function(e){for(var t,o=0,n=this.list;o<n.length;o++)if(t=n[o],e==t.name)return t;return this.list[0]},e.list=[new e("red",255,0,0),new e("green",0,255,0),new e("blue",0,0,255),new e("cyan",0,255,255),new e("purple",255,0,255),new e("yellow",255,255,0),new e("gray",127,127,127),new e("white",255,255,255)],e}(),v=/** @class */function(){function e(e,t,o){this.name=e,this.buttonColor=t,this.value=o}return e.findByName=function(e){for(var t,o=0,n=this.list;o<n.length;o++)if(t=n[o],e==t.name)return t;return this.list[0]},e.findByValue=function(e){for(var t,o=0,n=this.list;o<n.length;o++)if(t=n[o],e==t.value)return t;return this.list[0]},e.list=[new e("25","rgb(191,191,191)",.25),new e("50","rgb(127,127,127)",.5),new e("75","rgb(63,63,63)",.75),new e("100","rgb(0,0,0)",1)],e}(),b=/** @class */function(){function e(){}return e.copyToClipboard=function(e){var t=document.getElementById(e);t.select(),document.execCommand("Copy"),t.blur()},e.setContent=function(e,t){var o=document.getElementById(e);o.innerHTML=t},e.bindButtonOnClick=function(e,t){var o=document.getElementById(e);o.onclick=t},e.setVisibility=function(e,t){var o=document.getElementById(e);o.style.display=t?"block":"none"},e.bindCheckbox=function(e,t,o){var n=document.getElementById(e);n.checked=t,n.onchange=function(){o(n.checked)}},e.bindSelect=function(e,t,o,n){var i=document.getElementById(e);i.options.length=0;for(var a,r=0,l=t;r<l.length;r++)a=l[r],i.add(new Option(a,a));var s=t.indexOf(o);0<s&&(i.options[s].selected=!0),i.onchange=function(){n(i.selectedIndex,i.options[i.selectedIndex].value)}},e.bindValue=function(e,t,o){var n=document.getElementById(e);n.value=t,n.oninput=n.onchange=function(){o(n.value)}},e.bindColor=function(e,t,o,n,i){var a=document.getElementById(e),r=document.getElementById(t);a.innerHTML="",r.innerHTML="";for(var l=o,s=n,p=0,d=f.list;p<d.length;p++){var y=d[p],c=e+"_"+y.name,m="background:"+y.name;a.innerHTML=a.innerHTML+"<button id=\""+c+"\" class=\"configColorButton\" style=\""+m+"\"></button>\n"}for(var u=0,g=v.list;u<g.length;u++){var h=g[u],c=t+"_"+h.name,m="background:"+h.buttonColor;r.innerHTML=r.innerHTML+"<button id=\""+c+"\" class=\"configAlphaButton\" style=\""+m+"\"></button>\n"}for(var y,x=function(t){var o=e+"_"+t.name,n=document.getElementById(o);n.onclick=function(){l=t,i(l,s)}},b=0,C=f.list;b<C.length;b++)y=C[b],x(y);for(var h,_=function(e){var o=t+"_"+e.name,n=document.getElementById(o);n.onclick=function(){s=e,i(l,s)}},k=0,S=v.list;k<S.length;k++)h=S[k],_(h)},e.bindNumber=function(e,t,o){var n=document.getElementById(e);n.value=t.toString(),n.oninput=n.onchange=function(){var e=parseFloat(n.value);0<=e?o(e):(n.value="0",o(0))}},e}(),C=/** @class */function(t){function o(e){return t.call(this,"image",e)||this}return e(o,t),o.prototype.loadMap=function(t){this.map=t,this.maxLevel=t.maxLevel;var o=t.githubRepo.indexOf("/"),n=t.githubRepo.substring(0,o),i=t.githubRepo.substring(o+1);this.baseFolder="https://"+n+".github.io/"+i+"/"+this.map.name,this.currentZoom=-1;var a=document.getElementById("imageSource");b.setVisibility("imageSource",!!t.source),t.source&&(a.href=t.source,a.innerHTML=t.source);var r=this;this._mouseListener=new(/** @class */function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.down=!1,e.lastX=-1,e.lastY=-1,e}return e(o,t),o.prototype.onwheel=function(e){var t=r.canvas.getCamera();t.action();var o=t.screenXyToCanvas(e.offsetX,e.offsetY);t.changeZoomBy(0<e.deltaY?1:-1),t.action();var n=t.screenXyToCanvas(e.offsetX,e.offsetY),i=o.x-n.x,a=o.y-n.y;return t.moveXy(i,a),r.canvas.requestRender(),!0},o.prototype.onmousedown=function(e){return this.down=!0,this.lastX=e.offsetX,this.lastY=e.offsetY,!0},o.prototype.onmouseup=function(){return this.down=!1,!0},o.prototype.onmousemove=function(e){if(this.down&&0<e.buttons){var t=r.canvas.getCamera();t.action();var o=t.screenXyToCanvas(this.lastX,this.lastY),n=t.screenXyToCanvas(e.offsetX,e.offsetY),i=o.x-n.x,a=o.y-n.y;return t.moveXy(i,a),this.lastX=e.offsetX,this.lastY=e.offsetY,r.canvas.requestRender(),!0}return!1},o}(x))},o.prototype.prepare=function(e,t){var o=e.getZoom();if(this.currentZoom!==o){this.currentZoom=o;var n=this.map.tileSize<<o,a=this.map.levels[o];this.xCount=a.xMax,this.yCount=a.yMax,this.imageMatrix=[];for(var r=0;r<this.xCount;r++){this.imageMatrix[r]=[];for(var l=0;l<this.yCount;l++)this.imageMatrix[r][l]=new h(this.baseFolder+"/"+o+"/"+r+"_"+l+".jpg",r*n,l*n,n,n,function(){t.requestRender()})}}},o.prototype.render=function(e){if(this.prepare(this.camera,this.canvas),this.imageMatrix)for(var t=0;t<this.xCount;t++)for(var o=0;o<this.yCount;o++)this.imageMatrix[t][o].render(this.canvas,e,this.camera)},o.prototype.unload=function(){t.prototype.unload.call(this)},o}(u),_=/** @class */function(){function e(e,t,o,a){void 0===e&&(e=i()),void 0===t&&(t=i()),void 0===o&&(o=n()),void 0===a&&(a=n()),this.x1=e,this.y1=t,this.x2=o,this.y2=a}return e.prototype.set=function(e,t,o,n){this.x1=e,this.y1=t,this.x2=o,this.y2=n},e}(),k=/** @class */function(){return function(e,t){this.x=e,this.y=t}}(),S=/** @class */function(){return function(e,t,o,n){this.position=e,this.p1Index=t,this.p2Index=o,this.distance=n}}(),E=/** @class */function(){return function(e,t,o,n,i,a,r,l,s){this.points=e,this.closed=t,this.lineWidth=o,this.fill=n,this.fillColorName=i,this.fillAlphaName=a,this.stroke=r,this.strokeColorName=l,this.strokeAlphaName=s}}(),T=/** @class */function(){function e(e,t){this.polyline=e,this.points=t}return e.sqr=function(e,t){return e*e+t*t},e.testPointSegment=function(t,n,i,a,r){var l=t[n],s=t[i],p=s.x-l.x,d=s.y-l.y,y=e.sqr(p,d);if(1e-4>y)return null;var c=((a-l.x)*p+(r-l.y)*d)/y;1<c&&(c=1),0>c&&(c=0);var m=l.x+c*p,u=l.y+c*d,g=e.sqr(a-m,r-u);return new S(new k(m,u),n,i,o(g))},e.testPointPolygon=function(e,t,o){for(var n=e.length,a=!1,l=0,s=n-1;l<n;s=l++)e[l].y>o!=e[s].y>o&&t<(e[s].x-e[l].x)*(o-e[l].y)/(e[s].y-e[l].y)+e[l].x&&(a=!a);return a},e.prototype.pickPoint=function(t,o,n){for(var i,a=this.points,r=0,l=a;r<l.length;r++)if(i=l[r],e.sqr(i.x-t,i.y-o)<=n*n)return a.indexOf(i);return null},e.prototype.pickLine=function(t,o,n){for(var a=Number.MAX_VALUE,r,l=null,s=a,p=this.points,d=p.length,y=0,c=d-1;y<d;c=y++)r=e.testPointSegment(p,y,c,t,o),r&&r.distance<n&&r.distance<s&&(s=r.distance,l=r);return l},e.prototype.pickShape=function(t,o){return this.polyline.style.fill&&e.testPointPolygon(this.points,t,o)},e}(),w=/** @class */function(){function e(e,t){this.polyline=e,this.points=t}return e.prototype.forEachPoint=function(e){this.points.forEach(function(t,o){e(t.x,t.y,o)})},e.prototype.pointCount=function(){return this.points.length},e.prototype.getPoint=function(e){var t=this.points;return e=(e+t.length)%t.length,t[e]},e.prototype.addPoint=function(e,t){this.points.push(new k(e,t)),this.polyline.invalidate()},e.prototype.insertPoint=function(e,t,o){void 0===o&&(o=-1);var n=this.points;o=(o+n.length)%n.length,n.splice(o,0,new k(e,t)),this.polyline.invalidate()},e.prototype.removePoint=function(e){var t=this.points;e=(e+t.length)%t.length,t.splice(e,1),this.polyline.invalidate()},e.prototype.setPoint=function(e,t,o){var n=this.points;e=(e+n.length)%n.length;var i=n[e];i.x=t,i.y=o,this.polyline.invalidate()},e.prototype.move=function(e,t){for(var o,n=0,i=this.points;n<i.length;n++)o=i[n],o.x+=e,o.y+=t;this.polyline.invalidate()},e.prototype.flipX=function(){for(var e,t=i(),o=n(),a=0,r=this.points;a<r.length;a++)e=r[a],t=i(t,e.x),o=n(o,e.x);for(var e,l=t+o,s=0,p=this.points;s<p.length;s++)e=p[s],e.x=l-e.x},e.prototype.flipY=function(){for(var e,t=i(),o=n(),a=0,r=this.points;a<r.length;a++)e=r[a],t=i(t,e.y),o=n(o,e.y);for(var e,l=t+o,s=0,p=this.points;s<p.length;s++)e=p[s],e.y=l-e.y},e.prototype.rotateCW=function(){for(var e=this.polyline.calculator.aabbCenter(),t=0,o=this.points;t<o.length;t++){var n=o[t],i=n.x-e.x,a=n.y-e.y;n.x=e.x-a,n.y=e.y+i}},e.prototype.rotateCCW=function(){for(var e=this.polyline.calculator.aabbCenter(),t=0,o=this.points;t<o.length;t++){var n=o[t],i=n.x-e.x,a=n.y-e.y;n.x=e.x+a,n.y=e.y-i}},e}(),P=/** @class */function(){var t=Math.abs;function e(e,t){this.polyline=e,this.points=t}return e.prototype.centroid=function(){for(var e=0,t=0,o=0,n=0;n<this.points.length;n++){var a=this.points[n],r=this.points[(n+1)%this.points.length],l=a.x*r.y-r.x*a.y;e+=l,t+=(a.x+r.x)*l,o+=(a.y+r.y)*l}var s=t/6/(e/2),p=o/6/(e/2);return new k(s,p)},e.prototype.aabb=function(e){void 0===e&&(e=new _),e||(e=new _);for(var t,o=i(),a=n(),r=i(),l=n(),s=0,p=this.points;s<p.length;s++)t=p[s],o=i(o,t.x),a=n(a,t.x),r=i(r,t.y),l=n(l,t.y);return e.set(o,r,a,l),e},e.prototype.aabbCenter=function(){var e=this.aabb(),t=new k((e.x1+e.x2)/2,(e.y1+e.y2)/2);return t},e.prototype.area=function(){if(3>this.points.length)return 0;for(var e=this.points[0].y*(this.points[this.points.length-1].x-this.points[1].x),o=1;o<this.points.length;o++)e+=this.points[o].y*(this.points[o-1].x-this.points[(o+1)%this.points.length].x);return t(.5*e)},e.prototype.length=function(){if(2>this.points.length)return 0;var t=0,o=this.points[0],n=this.points[this.points.length-1];this.polyline.style.closed&&(t=e.hypot(o.x-n.x,o.y-n.y));for(var a=0;a<this.points.length-1;a++){var r=this.points[a],l=this.points[a+1];t+=e.hypot(r.x-l.x,r.y-l.y)}return t},e.hypot=function(e,t){return o(e*e+t*t)},e.prototype.alignPoint=function(e,o){e=(e+this.points.length)%this.points.length;var n=this.points[e],i=n.x,a=n.y,r=this.points[(e+1)%this.points.length];if(t(r.x-n.x)<=o&&(i=r.x),t(r.y-n.y)<=o&&(a=r.y),2<this.points.length){var l=this.points[(e-1+this.points.length)%this.points.length];t(l.x-n.x)<=o&&(i=l.x),t(l.y-n.y)<=o&&(a=l.y)}return new k(i,a)},e}(),N=/** @class */function(){function e(e){this._closed=e.closed,this._lineWidth=e.lineWidth,this._fill=e.fill,this._fillColor=f.findByName(e.fillColorName),this._fillAlpha=v.findByName(e.fillAlphaName),this._fillString=t(this._fillColor,this._fillAlpha),this._stroke=e.stroke,this._strokeColor=f.findByName(e.strokeColorName),this._strokeAlpha=v.findByName(e.strokeAlphaName),this._strokeString=t(this._strokeColor,this._strokeAlpha)}return Object.defineProperty(e.prototype,"closed",{get:function(){return this._closed},set:function(e){this._closed=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineWidth",{get:function(){return this._lineWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fill",{get:function(){return this._fill},set:function(e){this._fill=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillColor",{get:function(){return this._fillColor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillAlpha",{get:function(){return this._fillAlpha},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillString",{get:function(){return this._fillString},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stroke",{get:function(){return this._stroke},set:function(e){this._stroke=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokeColor",{get:function(){return this._strokeColor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokeAlpha",{get:function(){return this._strokeAlpha},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokeString",{get:function(){return this._strokeString},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onScreen",{get:function(){return this._lineWidth.onScreen},set:function(e){this._lineWidth.onScreen=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onCanvas",{get:function(){return this._lineWidth.onCanvas},set:function(e){this._lineWidth.onCanvas=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ofScreen",{get:function(){return this._lineWidth.ofScreen},set:function(e){this._lineWidth.ofScreen=e},enumerable:!0,configurable:!0}),e.prototype.pack=function(){return new E(null,this._closed,this._lineWidth,this._fill,this._fillColor.name,this._fillAlpha.name,this._stroke,this._strokeColor.name,this._strokeAlpha.name)},e.prototype.setFillColor=function(e,o){this._fillColor=e,this._fillAlpha=o,this._fillString=t(this._fillColor,this._fillAlpha)},e.prototype.setStrokeColor=function(e,o){this._strokeColor=e,this._strokeAlpha=o,this._strokeString=t(this._strokeColor,this._strokeAlpha)},e}(),I=/** @class */function(t){function o(e){var o=t.call(this)||this;return o.canvasAABB=new _,o.valid=!1,o.points=e.points,o.style=new N(e),o.picker=new T(o,o.points),o.editor=new w(o,o.points),o.calculator=new P(o,o.points),o}return e(o,t),o.prototype.clone=function(e,t){void 0===e&&(e=0),void 0===t&&(t=0);for(var o,n=[],i=0,a=this.points;i<a.length;i++)o=a[i],n.push(new k(o.x+e,o.y+t));var r=this.style.pack();return r.points=n,r},o.prototype.pack=function(){var e=this.style.pack();return e.points=this.points,e},o.prototype.invalidate=function(){this.valid=!1},o.prototype.validate=function(){this.valid||this.calculator.aabb(this.canvasAABB)},o.prototype.render=function(e,t,o){this.validate();var n=o.canvasAABBInScreen(this.canvasAABB);n&&(t.setFillColor(this.style.fillString),t.setStrokeColor(this.style.strokeString),t.renderPolyline(o,this.points,this.style.closed,this.style.fill,this.style.stroke,this.style.lineWidth))},o.typeName="DrawablePolyline",o}(g),L=/** @class */function(){function e(){}return e.register=function(e,t,o){e&&(t&&(this.mapSelect[e]=t),o&&(this.mapDeselect[e]=o)),this.listDeselect.push(o)},e.deselectAll=function(){for(var e,t=0,o=this.listDeselect;t<o.length;t++)e=o[t],e()},e.deselect=function(e){var t=this.mapDeselect[e];t&&t()},e.select=function(e,t){this.deselectAll();var o=this.mapSelect[e];o&&o(t)},e.listDeselect=[],e.mapSelect={},e.mapDeselect={},e}(),B=/** @class */function(t){function o(e){var n=t.call(this,o.layerName,e)||this;return n.polylines=[],n}return e(o,t),o.prototype.loadData=function(t){if(this.polylines=[],t.polylines)for(var o,n=0,i=t.polylines;n<i.length;n++)o=i[n],this.polylines.push(new I(o));//listen to mouse click to select polyline
var a=this;this._mouseListener=new(/** @class */function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.moved=!1,e}return e(o,t),o.prototype.onmousedown=function(){return this.moved=!1,!1},o.prototype.onmouseup=function(e){if(0==e.button&&!this.moved){for(var t=a.camera.screenSizeToCanvas(5),o=a.camera.screenXyToCanvas(e.offsetX,e.offsetY),n=o.x,i=o.y,r=null,l=0,s=a.polylines;l<s.length;l++){var p=s[l],d=p.picker.pickPoint(n,i,t),y=p.picker.pickLine(n,i,t),c=p.picker.pickShape(n,i);(null!=d||y||c)&&(r=p)}return r?(L.select(I.typeName,r),!0):(L.deselect(I.typeName),!1)}return!1},o.prototype.onmousemove=function(e){return 1&e.buttons&&0!=e.movementX&&0!=e.movementY&&(this.moved=!0),!1},o}(x))},o.prototype.addPolyline=function(e){this.polylines.push(e),this.canvas.requestRender()},o.prototype.deletePolyline=function(e){var t=this.polylines.indexOf(e);return-1!==t&&(this.polylines.splice(t,1),!0)},o.prototype.containPolyline=function(e){return 0<=this.polylines.indexOf(e)},o.prototype.saveData=function(e){e.polylines=[];for(var t,o=0,n=this.polylines;o<n.length;o++)t=n[o],e.polylines.push(t.pack())},o.prototype.render=function(e){t.prototype.render.call(this,e);for(var o,n=0,i=this.polylines;n<i.length;n++)o=i[n],o.render(this.canvas,e,this.camera)},o.prototype.unload=function(){t.prototype.unload.call(this)},o.layerName="polyline view",o}(u),A=/** @class */function(){return function(e,t,o){this.onScreen=e,this.onCanvas=t?t:0,this.ofScreen=o?o:0}}(),X=/** @class */function(t){function n(e){var o=t.call(this,n.layerName,e)||this;o.polylineNew=null,o.polylineEdit=null;return L.register(I.typeName,function(e){o.startEditingPolyline(e)},function(){o.finishEditing()}),o}return e(n,t),n.prototype.loadMap=function(e){this.map=e},n.prototype.loadData=function(){this.layerView=this.canvas.findLayer(B.layerName),this.polylineNew=null,this.polylineEdit=null,this.finishEditing(),b.setVisibility("panelPolylineSelected",!1)},n.prototype.startCreatingPolyline=function(){this.finishEditing();var t=this;return this.polylineNew=new I(new E([],!0,new A(2),!0,"white","25",!0,"white","75")),this.bindPolylineConfigUi(this.polylineNew),b.setContent(n.HINT_ELEMENT_ID,n.HINT_NEW_POLYLINE),this._mouseListener=new(/** @class */function(o){function i(){var e=null!==o&&o.apply(this,arguments)||this;return e.down=!1,e.moved=!1,e}return e(i,o),i.prototype.preview=function(e,o){if(t.polylineNew.editor.setPoint(-1,e.x,e.y),o){var i=t.camera.screenSizeToCanvas(n.MAG_RADIUS),a=t.polylineNew.calculator.alignPoint(-1,i);t.polylineNew.editor.setPoint(-1,a.x,a.y)}},i.prototype.onmousedown=function(e){if(0==e.button&&!this.down){this.down=!0;var o=t.camera.screenXyToCanvas(e.offsetX,e.offsetY);return t.polylineNew.editor.addPoint(o.x,o.y),t.canvas.requestRender(),!0}return 2==e.button&&(this.moved=!1),!1},i.prototype.onmouseup=function(e){if(0==e.button){this.down=!1;var o=t.camera.screenXyToCanvas(e.offsetX,e.offsetY);return this.preview(o,e.ctrlKey),t.canvas.requestRender(),!0}if(2==e.button){if(!this.moved){var n=t.polylineNew;t.finishEditing(),t.layerView.containPolyline(n)&&t.startEditingPolyline(n)}return this.moved=!1,!0}return!1},i.prototype.onmousemove=function(e){if(this.down){//left button is down => show modification
var o=t.camera.screenXyToCanvas(e.offsetX,e.offsetY);return this.preview(o,e.ctrlKey),t.canvas.requestRender(),!0}return 2&e.buttons&&(this.moved=!0),!1},i}(x)),this.polylineNew},n.prototype.deleteCreating=function(){this.polylineNew=null,this.finishEditing(),this.canvas.requestRender()},n.prototype.startEditingPolyline=function(t){this.finishEditing(),this.polylineEdit=t,this.bindPolylineConfigUi(this.polylineEdit),b.setContent(n.HINT_ELEMENT_ID,n.HINT_EDIT_POLYLINE);//start listening to mouse events: drag point, remove point on double click, add point on double click
var o=this;this._mouseListener=new(/** @class */function(i){function a(){var e=null!==i&&i.apply(this,arguments)||this;return e.down=!1,e.moved=!1,e.dragPointIndex=null,e.dragShape=!1,e.dragShapeX=-1,e.dragShapeY=-1,e}return e(a,i),a.prototype.onmousedown=function(e){if(this.dragPointIndex=null,0==e.button){this.down=!0;//test point
var n=o.camera.screenXyToCanvas(e.offsetX,e.offsetY),i=t.picker.pickPoint(n.x,n.y,o.camera.screenSizeToCanvas(5));if(null!=i)return this.dragPointIndex=i,!0;var a=t.picker.pickShape(n.x,n.y);if(null==i&&a&&e.altKey){if(e.ctrlKey){var r=new I(t.clone());o.layerView.addPolyline(r)}this.dragShape=!0,this.dragShapeX=n.x,this.dragShapeY=n.y}}else 2==e.button&&(this.moved=!1);return!1},a.prototype.onmouseup=function(e){var n=null!=this.dragPointIndex||!!this.dragShape;//pass event if not dragging, so that LayerPolylineView will deselect this polyline
if(this.dragPointIndex=null,this.dragShape=!1,this.dragShapeX=-1,this.dragShapeY=-1,0==e.button)return this.down=!1,n;if(2==e.button){var i=!1;if(!this.moved){var a=o.camera.screenXyToCanvas(e.offsetX,e.offsetY),r=t.picker.pickPoint(a.x,a.y,o.camera.screenSizeToCanvas(5));//test points
null!=r&&(3<t.editor.pointCount()&&(t.editor.removePoint(r),o.canvas.requestRender()),i=!0)}return this.moved=!1,i}return!1},a.prototype.ondblclick=function(e){if(0==e.button){var n=o.camera.screenXyToCanvas(e.offsetX,e.offsetY),i=t.picker.pickPoint(n.x,n.y,o.camera.screenSizeToCanvas(5));//test points
if(null!=i)return 3<t.editor.pointCount()&&(t.editor.removePoint(i),o.canvas.requestRender()),!0;//test segments
var a=t.picker.pickLine(n.x,n.y,o.camera.screenSizeToCanvas(5));if(a){//add point
var r=a.p1Index;//insert point after p1
return t.editor.insertPoint(a.position.x,a.position.y,r),o.canvas.requestRender(),!0}}return!1},a.prototype.onmousemove=function(e){if(this.down){//left button is down => drag
var i=o.camera.screenXyToCanvas(e.offsetX,e.offsetY);if(null!=this.dragPointIndex){if(t.editor.setPoint(this.dragPointIndex,i.x,i.y),e.ctrlKey){var a=o.camera.screenSizeToCanvas(n.MAG_RADIUS),r=t.calculator.alignPoint(this.dragPointIndex,a);t.editor.setPoint(this.dragPointIndex,r.x,r.y)}return o.canvas.requestRender(),!0}if(this.dragShape)return t.editor.move(i.x-this.dragShapeX,i.y-this.dragShapeY),this.dragShapeX=i.x,this.dragShapeY=i.y,o.canvas.requestRender(),!0}else 2&e.buttons&&(this.moved=!0);return!1},a}(x)),this.canvas.requestRender()},n.prototype.finishEditing=function(){b.setVisibility("panelPolylineSelected",!1),this.polylineNew&&(2<this.polylineNew.editor.pointCount()&&this.layerView.addPolyline(this.polylineNew),this.polylineNew=null,this.canvas.requestRender()),this.polylineEdit&&(this.polylineEdit=null,this.canvas.requestRender()),this._mouseListener=null},n.prototype.render=function(e){var t=this;if(this.polylineNew){this.polylineNew.render(this.canvas,e,this.camera);//draw two points
var o=this.polylineNew.editor.pointCount();if(0<o){var n=this.polylineNew.editor.getPoint(0);this.drawPointCircle(n.x,n.y,e)}if(1<o){var n=this.polylineNew.editor.getPoint(-1);this.drawPointCircle(n.x,n.y,e)}}this.polylineEdit&&this.polylineEdit.editor.forEachPoint(function(o,n){t.drawPointCircle(o,n,e)})},n.prototype.drawPointCircle=function(e,t,o){var n=this.camera.canvasToScreen(e,t);o.setColor("rgba(255,255,255,1)"),o.drawCircle(n.x,n.y,5,!1,!0,1),o.setColor("rgba(0,0,0,0.5)"),o.drawCircle(n.x,n.y,4,!0,!1)},n.prototype.deleteEditing=function(){this.polylineEdit&&(this.layerView.deletePolyline(this.polylineEdit),this.finishEditing())},n.prototype.bindPolylineConfigUi=function(e){var t=this;b.setVisibility("panelPolylineSelected",!0),b.bindButtonOnClick("polylineButtonCopy",function(){var o=t.canvas.getCamera().screenSizeToCanvas(20),n=new I(e.clone(o,o));t.finishEditing(),t.layerView.addPolyline(n),t.startEditingPolyline(n),t.canvas.requestRender()}),b.setVisibility("polylineAreaContainer",0<this.map.widthMillimeter&&0<this.map.heightMillimeter),b.bindButtonOnClick("polylineButtonArea",function(){var n=Math.round;if(0<t.map.widthMillimeter&&0<t.map.heightMillimeter)if(b.setContent("poylineTextArea",""),e.style.fill){var i=e.calculator.area(),a=i/t.map.width/t.map.height*t.map.widthMillimeter*t.map.heightMillimeter;a=n(100*a)/100,b.setContent("poylineTextArea",a+"mm^2")}else{var r=e.calculator.length(),l=r*o(t.map.widthMillimeter*t.map.heightMillimeter/t.map.width/t.map.height);l=n(100*l)/100,b.setContent("poylineTextArea",l+"mm")}}),b.setContent("poylineTextArea",""),b.bindButtonOnClick("polylineButtonRotateCCW",function(){e.editor.rotateCCW(),t.canvas.requestRender()}),b.bindButtonOnClick("polylineButtonRotateCW",function(){e.editor.rotateCW(),t.canvas.requestRender()}),b.bindButtonOnClick("polylineButtonFlipX",function(){e.editor.flipX(),t.canvas.requestRender()}),b.bindButtonOnClick("polylineButtonFlipY",function(){e.editor.flipY(),t.canvas.requestRender()}),b.bindCheckbox("polylineCheckboxFill",e.style.fill,function(o){e.style.fill=o,t.canvas.requestRender()}),b.bindCheckbox("polylineCheckboxStroke",e.style.stroke,function(o){e.style.stroke=o,t.canvas.requestRender()}),b.bindCheckbox("polylineCheckboxClosed",e.style.closed,function(o){e.style.closed=o,t.canvas.requestRender()}),b.bindNumber("polylineTextSizeOnScreen",e.style.onScreen,function(o){e.style.onScreen=o,t.canvas.requestRender()}),b.bindNumber("polylineTextSizeOnCanvas",e.style.onCanvas,function(o){e.style.onCanvas=o,t.canvas.requestRender()}),b.bindNumber("polylineTextSizeOfScreen",1e3*e.style.ofScreen,function(o){e.style.ofScreen=.001*o,t.canvas.requestRender()}),b.bindColor("polylineContainerStrokeColor","polylineContainerStrokeAlpha",e.style.strokeColor,e.style.strokeAlpha,function(o,n){e.style.setStrokeColor(o,n),t.canvas.requestRender()}),b.bindColor("polylineContainerFillColor","polylineContainerFillAlpha",e.style.fillColor,e.style.fillAlpha,function(o,n){e.style.setFillColor(o,n),t.canvas.requestRender()})},n.layerName="polyline edit",n.HINT_ELEMENT_ID="polylineHint",n.HINT_NEW_POLYLINE="1. left click to create point<br>2. hold left button to preview point<br>3. right click to finish creating<br>4. hold ctrl to help with horizontal/vertical line<br>",n.HINT_EDIT_POLYLINE="1. hold left button to drag points<br>2. hold ctrl to help with horizontal/vertical line<br>3. hold alt to drag polyline<br>4. hold ctrl+alt to copy and drag polyline<br>5. double click on line to create point<br>6. right-click / double left-click point to delete it<br>",n.MAG_RADIUS=10,n}(u),R=/** @class */function(){return function(e,t,o,// anchorX: CanvasTextAlign, anchorY: CanvasTextBaseline,
n,i,a){this.text="",this.text=e,this.colorName=t,this.alphaName=o,this.fontSize=n,this.x=i,this.y=a}}(),M=/** @class */function(o){function n(e){var n=o.call(this)||this;return n._text="",n._canvasAABB=new _,n.sizeValid=!1,n.canvasZoom=-1,n.canvasWidth=0,n.canvasHeight=0,n.screenWidth=0,n.screenHeight=0,n._text=e.text,n.color=f.findByName(e.colorName),n.alpha=v.findByName(e.alphaName),n.colorString=t(n.color,n.alpha),n.fontSize=e.fontSize,n._x=e.x,n._y=e.y,n}return e(n,o),n.prototype.invalidate=function(){this.sizeValid=!1},Object.defineProperty(n.prototype,"text",{get:function(){return this._text},set:function(e){this._text=e,this.invalidate()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),n.prototype.validateCanvasAABB=function(e,t){return this.validate(e,t),this._canvasAABB},Object.defineProperty(n.prototype,"onScreen",{get:function(){return this.fontSize.onScreen},set:function(e){this.fontSize.onScreen=e,this.invalidate()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"onCanvas",{get:function(){return this.fontSize.onCanvas},set:function(e){this.fontSize.onCanvas=e,this.invalidate()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ofScreen",{get:function(){return this.fontSize.ofScreen},set:function(e){this.fontSize.ofScreen=e,this.invalidate()},enumerable:!0,configurable:!0}),n.prototype.setPosition=function(e,t){this._x=e,this._y=t,this.invalidate()},n.prototype.setColorAlpha=function(e,o){this.color=e,this.alpha=o,this.colorString=t(this.color,this.alpha)},n.prototype.clone=function(e,t){return new R(this._text,this.color.name,this.alpha.name,this.fontSize,this._x+e,this._y+t)},n.prototype.pack=function(){return new R(this._text,this.color.name,this.alpha.name,this.fontSize,this._x,this._y)},n.prototype.render=function(e,t,o){t.setColor(this.colorString),this.validate(o,t);var n=o.canvasAABBInScreen(this._canvasAABB);n&&t.renderText(o,this._text,this.screenHeight,this._x,this._y,"center","middle")},n.prototype.validate=function(e,t){if(!this.sizeValid||this.canvasZoom!=e.getZoom()){this.sizeValid=!0;var o=t.measureText(e,this._text,this.fontSize),n=e.screenSizeToCanvas(1);this.canvasZoom=e.getZoom(),this.canvasWidth=o[0]*n/2,this.canvasHeight=o[1]*n/2,this.screenWidth=o[0],this.screenHeight=o[1],this.calcCanvasAABB()}},n.prototype.pick=function(e,t,o){var n=this._x-this.canvasWidth-o<=e&&e<=this._x+this.canvasWidth+o,i=this._y-this.canvasHeight-o<=t&&t<=this._y+this.canvasHeight+o;return n&&i},n.prototype.calcCanvasAABB=function(){return this._canvasAABB.x1=this.x-this.canvasWidth,this._canvasAABB.y1=this.y-this.canvasHeight,this._canvasAABB.x2=this.x+this.canvasWidth,this._canvasAABB.y2=this.y+this.canvasHeight,this._canvasAABB},n.typeName="DrawableText",n}(g),D=/** @class */function(t){function o(e){var n=t.call(this,o.layerName,e)||this;return n.texts=[],n}return e(o,t),o.prototype.loadData=function(t){if(this.texts=[],t.texts)for(var o,n=0,i=t.texts;n<i.length;n++)o=i[n],this.texts.push(new M(o));//listen to mouse click to select text
var a=this;this._mouseListener=new(/** @class */function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.moved=!1,e}return e(o,t),o.prototype.onmousedown=function(){return this.moved=!1,!1},o.prototype.onmouseup=function(e){if(0==e.button&&!this.moved){for(var t=a.camera.screenXyToCanvas(e.offsetX,e.offsetY),o=t.x,n=t.y,i=null,r=0,l=a.texts;r<l.length;r++){var s=l[r],p=s.pick(o,n,a.camera.screenSizeToCanvas(5));p&&(i=s)}return i?(L.select(M.typeName,i),!0):(L.deselect(M.typeName),!1)}return!1},o.prototype.onmousemove=function(e){return 1&e.buttons&&0!=e.movementX&&0!=e.movementY&&(this.moved=!0),!1},o}(x))},o.prototype.addText=function(e){this.texts.push(e),this.canvas.requestRender()},o.prototype.deleteText=function(e){var t=this.texts.indexOf(e);return-1!==t&&(this.texts.splice(t,1),!0)},o.prototype.saveData=function(e){e.texts=[];for(var t,o=0,n=this.texts;o<n.length;o++)t=n[o],e.texts.push(t.pack())},o.prototype.render=function(e){t.prototype.render.call(this,e);for(var o,n=0,i=this.texts;n<i.length;n++)o=i[n],o.render(this.canvas,e,this.camera)},o.prototype.unload=function(){t.prototype.unload.call(this)},o.layerName="text view",o}(u),z=/** @class */function(t){function o(e){var n=t.call(this,o.layerName,e)||this;n.textEdit=null;var i=n;return L.register(M.typeName,function(e){i.startEditingText(e)},function(){i.finishEditing()}),n}return e(o,t),o.prototype.loadData=function(){this.layerView=this.canvas.findLayer(D.layerName),this.finishEditing(),b.setVisibility("panelTextSelected",!1)},o.prototype.startCreatingText=function(){this.finishEditing();var t=this,n=new M(new R("text","white","100",new A(20,50),0,0));//show text and its point indicators
this.bindTextConfigUi(n),b.setContent(o.HINT_ELEMENT_ID,o.HINT_NEW_TEXT),this._mouseListener=new(/** @class */function(o){function i(){var e=null!==o&&o.apply(this,arguments)||this;return e.down=!1,e}return e(i,o),i.prototype.onmousedown=function(e){return 0==e.button&&(this.down=!0,!0)},i.prototype.onmouseup=function(e){if(0==e.button){this.down=!1;var o=t.camera.screenXyToCanvas(e.offsetX,e.offsetY);return n.setPosition(o.x,o.y),t.layerView.addText(n),L.select(M.typeName,n),t.canvas.requestRender(),!0}return!1},i.prototype.onmousemove=function(e){return 1&e.buttons&&this.down},i}(x))},o.prototype.startEditingText=function(t){this.finishEditing(),this.textEdit=t,this.bindTextConfigUi(this.textEdit),b.setContent(o.HINT_ELEMENT_ID,o.HINT_EDIT_TEXT);//start listening to mouse events: drag point, remove point on double click, add point on double click
var n=this;this._mouseListener=new(/** @class */function(o){function i(){var e=null!==o&&o.apply(this,arguments)||this;return e.down=!1,e.drag=!1,e.dragX=0,e.dragY=0,e}return e(i,o),i.prototype.onmousedown=function(e){if(0==e.button){this.down=!0,this.drag=!1;//test
var o=n.camera.screenXyToCanvas(e.offsetX,e.offsetY),i=t.pick(o.x,o.y,n.camera.screenSizeToCanvas(5));if(i&&e.altKey){//start dragging
if(e.ctrlKey){var a=new M(t.clone(0,0));n.layerView.addText(a)}return this.drag=!0,this.dragX=o.x-t.x,this.dragY=o.y-t.y,e.altKey}}return!1},i.prototype.onmouseup=function(e){var t=!this.drag;//pass event if not moving point, so that LayerTextView will deselect this text
return this.drag=!1,0==e.button&&(this.down=!1,!t)},i.prototype.onmousemove=function(e){if(this.down&&this.drag){var t=n.camera.screenXyToCanvas(e.offsetX,e.offsetY);return n.textEdit.setPosition(t.x-this.dragX,t.y-this.dragY),n.canvas.requestRender(),!0}return!1},i}(x)),this.canvas.requestRender()},o.prototype.finishEditing=function(){b.setVisibility("panelTextSelected",!1),this.textEdit&&(0==this.textEdit.text.length&&this.layerView.deleteText(this.textEdit),this.textEdit=null,this.canvas.requestRender()),this._mouseListener=null},o.prototype.render=function(e){if(this.textEdit){e.setColor(this.textEdit.colorString);var t=this.textEdit.validateCanvasAABB(this.camera,e),o=this.camera.canvasToScreen(t.x1,t.y1),n=this.camera.canvasToScreen(t.x2,t.y2);e.drawRect(o.x-5,o.y-5,n.x+5,n.y+5,!1,!0,2)}},o.prototype.deleteEditing=function(){this.textEdit&&(this.layerView.deleteText(this.textEdit),this.finishEditing())},o.prototype.bindTextConfigUi=function(e){var t=this;b.setVisibility("panelTextSelected",!0),b.bindButtonOnClick("textButtonCopy",function(){var o=t.canvas.getCamera().screenSizeToCanvas(10),n=new M(e.clone(o,o));t.finishEditing(),t.layerView.addText(n),t.startEditingText(n),t.canvas.requestRender()}),b.bindValue("textTextContent",e.text,function(o){e.text=o,t.canvas.requestRender()}),b.bindNumber("textTextSizeOnScreen",e.onScreen,function(o){e.onScreen=o,t.canvas.requestRender()}),b.bindNumber("textTextSizeOnCanvas",e.onCanvas,function(o){e.onCanvas=o,t.canvas.requestRender()}),b.bindNumber("textTextSizeOfScreen",1e3*e.ofScreen,function(o){e.ofScreen=.001*o,t.canvas.requestRender()}),b.bindColor("textContainerColor","textContainerAlpha",e.color,e.alpha,function(o,n){e.setColorAlpha(o,n),t.canvas.requestRender()})},o.layerName="text edit",o.HINT_ELEMENT_ID="textHint",o.HINT_NEW_TEXT="1. left click to create text<br>",o.HINT_EDIT_TEXT="1. hold alt to drag<br>2. hold ctrl+alt to copy and drag <br>",o}(u),q=/** @class */function(){function e(){}return e.getComments=function(e,t,o){c.get("https://api.github.com/repos/"+e+"/issues/"+t+"/comments",function(e){try{var t=JSON.parse(e);o(t)}catch(t){}})},e.getIssueLink=function(e,t){return"https://github.com/"+e+"/issues/"+t},e.getCommentLink=function(e,t,o){return"https://github.com/"+e+"/issues/"+t+"#issuecomment-"+o},e}(),W=new y(document.getElementById("container"),"canvas2d");W.init();var H=new C(W),O=new B(W),Y=new X(W),V=new D(W),Z=new z(W);W.addLayer(H),W.addLayer(O),W.addLayer(Y),W.addLayer(V),W.addLayer(Z),b.bindButtonOnClick("buttonNewPolyline",function(){Z.finishEditing(),Y.startCreatingPolyline()}),b.bindButtonOnClick("polylineButtonDelete",function(){Y.deleteEditing(),Y.deleteCreating(),Z.finishEditing(),Y.finishEditing()}),b.bindButtonOnClick("buttonNewText",function(){Y.finishEditing(),Z.startCreatingText()}),b.bindButtonOnClick("textButtonDelete",function(){Y.finishEditing(),Z.deleteEditing(),Z.finishEditing()});var U=/** @class */function(){function e(){this.currentMapName=null,this.issueLink="",this.currentCommentId=0,this.dummyData=null}return e.prototype.start=function(){var e=this;c.get("https://misdake.github.io/ChipAnnotationData/list.txt",function(t){var o=null,n=[],i={},a=[];if(t&&t.length){n=t.split("\n").filter(function(e){return 0<e.length}).map(function(e){return e.trim()});for(var r=0,l=n;r<l.length;r++){var s=l[r],p=s.substring(s.lastIndexOf("/")+1);a.push(p),i[p]=s}0<n.length&&(o=a[0])}o||(o="Fiji");var d=window.location.href,y=new URL(d),c=y.searchParams.get("map")||o,m=y.searchParams.get("commentId")||"0";e.currentCommentId=parseInt(m),b.bindSelect("mapSelect",a,c,function(t,o){e.currentCommentId=0,e.loadMap(o,i[o]),e.replaceUrl()}),e.loadMap(c,i[c])})},e.prototype.loadMap=function(e,t){var o=this;this.currentMapName=e,c.get(t+"/content.json",function(e){var t=JSON.parse(e);W.loadMap(t),W.requestRender(),o.issueLink=q.getIssueLink(t.githubRepo,t.githubIssueId),b.bindButtonOnClick("buttonSave",function(){Z.finishEditing(),Y.finishEditing();var e=W.save();e.title=document.getElementById("dataTitle").value,(null==e.title||""==e.title)&&(e.title="untitled");var t=JSON.stringify(e);b.bindValue("dataOutput",t,function(){}),b.copyToClipboard("dataOutput"),b.bindValue("dataOutput","",function(){}),o.issueLink&&window.open(o.issueLink,"_blank")}),b.bindValue("dataOutput","",function(){}),b.bindValue("dataTitle","",function(){}),b.bindSelect("dataSelect",[],null,function(){}),o.dummyData=new d,o.dummyData.title="",W.loadData(o.dummyData),b.bindValue("dataOutput","",function(){}),o.loadGithubComment(t,o.currentCommentId),b.bindButtonOnClick("buttonRefreshData",function(){o.loadGithubComment(t,o.currentCommentId)})})},e.prototype.loadGithubComment=function(e,t){var o=this;e.githubRepo&&e.githubIssueId&&q.getComments(e.githubRepo,e.githubIssueId,function(n){var i=[],a=[],r=[];i.push(null),a.push(o.dummyData),r.push("(empty)");for(var l,s=0,p=o.dummyData,d=0,y=0,c=n;y<c.length;y++){l=c[y];try{var m=JSON.parse(l.body);null!=m.polylines&&null!=m.texts&&((null==m.title||""==m.title)&&(m.title="untitled"),i.push(l),a.push(m),r.push(m.title+" @"+l.user.login),t==l.id&&(s=i.length-1,p=m,d=l.id))}catch(t){}}b.bindSelect("dataSelect",r,r[s],function(t){var n=i[t],r=a[t];o.loadData(e,r,n?n.id:0)}),o.loadData(e,p,d)})},e.prototype.loadData=function(e,t,o){b.bindValue("dataTitle",t.title,function(){}),this.currentCommentId=o,this.issueLink=0<o?q.getCommentLink(e.githubRepo,e.githubIssueId,o):q.getIssueLink(e.githubRepo,e.githubIssueId),b.bindValue("dataOutput","",function(){}),W.loadData(t),this.replaceUrl(),W.requestRender()},e.prototype.replaceUrl=function(){var e=location.pathname+"?map="+this.currentMapName;0<this.currentCommentId&&(e+="&commentId="+this.currentCommentId),history.replaceState(null,"",e)},e}();new U().start()});
